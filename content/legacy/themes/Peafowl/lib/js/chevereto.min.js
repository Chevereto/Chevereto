CHV={obj:{},fn:{},str:{}},window.opener&&(CHV.obj.opener={uploadPlugin:{}}),CHV.fn.ctaButtons={selectors:{container:"[data-contains=cta-album]"},render:function(e=""){$(this.selectors.container).each(function(){$(this).html(e)})}},CHV.fn.ctaForm={enable:0,array:[],selectors:{root:"#cta-form",rows:"#cta-rows",enable:"#cta-enable",template:"#cta-row-template",combo:"#cta-combo",row:".cta-row"},update:function(e){let t=this.getPos(e),a=e.attr("name").match(/cta-(.*)?_\d+/)[1];this.array[t-1][a]=e.val()},add:function(e="",t="",a=""){this.array.push(this.getRowObject(e,t,a)),this.render()},insert:function(e){let t=this.getPos(e);this.array.splice(t,0,this.getRowObject()),this.render()},remove:function(e){let t=this.getPos(e);this.array.splice(t-1,1),this.render()},getRowObject:function(e="",t="",a=""){return{label:e,icon:t,href:a}},getIconClass:function(e){return/\s/g.test(e)?e:"fa-solid fa-"+e},getRow:function(e){return e.closest(this.selectors.row)},getPos:function(e){return this.getRow(e).data("pos")},getTemplateHtml:function(){return $(this.selectors.template).html()},getRowHtml:function(e,t){return this.getTemplateHtml().replaceAll(/%pos%/g,e).replaceAll(/%label%/g,t.label).replaceAll(/%href%/g,t.href).replaceAll(/%icon%/g,t.icon).replaceAll(/%iconClass%/g,this.getIconClass(t.icon))},render:function(){let e=$(this.selectors.root),t=e.find(this.selectors.rows),a=this;this.destroy(),$.each(this.array,function(e,o){t.append(a.getRowHtml(e+1,o))}),this.setEnable(this.enable),t.sortable({cursor:"grabbing",axis:"y",update:function(){let e=[];$(this).find(a.selectors.row).each(function(){let t=a.getPos($(this));e.push(a.array[t-1])}),a.array=e,a.render()}})},setEnable:function(e){let t=$(this.selectors.rows,this.selectors.root);this.enable=e;let a=1===this.enable;$("input[data-required]",t).each(function(){$(this).attr("required",a)})},destroy:function(){let e=$(this.selectors.root),t=e.find(this.selectors.rows);try{t.sortable("destroy")}catch(e){}t.empty()}},CHV.fn.album={showEmbedCodes:function(){var e=$(".content-listing-loading","#tab-embeds");if(e.exists()){var t=$("#embed-codes");$.ajax({url:PF.obj.config.json_api,type:"POST",dataType:"json",data:{action:"get-album-contents",albumid:CHV.obj.resource.id,auth_token:PF.obj.config.auth_token},cache:!1}).always(function(a){PF.fn.loading.destroy(e),200==a.status_code&&(CHV.fn.fillEmbedCodes(a.contents,"#tab-embeds"),$("#tab-embeds").addClass("visible"),t.removeClass("soft-hidden"))})}}},CHV.fn.modal={getTemplateWithPreview:function(e,t){var a=$(e).html(),o=$("<div/>"),i="",n=t.find(".image-container img").attr("src");return void 0!==n&&(i+='<a href="'+t.attr("data-url-short")+'" target="_blank"><img class="canvas checkered-background" src='+n+" /></a>"),o.html(a).find(".image-preview").html(i),o.html()},getTemplateWithPreviews:function(e,t,a=50){var o=$(e).html(),i=$("<div/>"),n="",r=0;return t.each(function(){if(r>=a)return!1;n+='<a class="image-preview-container checkered-background" href="'+$(this).attr("data-url-short")+'" target="_blank">';var e=$(this).find(".image-container img");e.exists()?n+='<canvas width="160" height="160" class="thumb" style="background-image: url('+e.attr("src")+');" />':(n+='<canvas width="160" height="160" class="thumb" />',n+='<span class="empty icon fas fa-inbox"></span>'),n+="</a>",r++}),i.html(o).find(".image-preview").html(n),i.html()}},CHV.fn.listingViewer={selectors:{bodyShown:".--viewer-shown",content:".viewer-content",template:"#viewer-template",root:".viewer",rootShow:".viewer--show",rootHide:".viewer--hide",rootZero:".viewer--zero",rootNavPrev:".viewer--nav-prev",rootNavNext:".viewer--nav-next",src:".viewer-src",tools:".viewer-tools",loader:".viewer-loader",owner:".viewer-owner",ownerGuest:".viewer-owner--guest",ownerUser:".viewer-owner--user",inputMap:".viewer-kb-input"},keys:{ArrowLeft:"prev",ArrowRight:"next",Delete:"delete",Escape:"close",KeyA:"create-album",KeyE:"edit",KeyF:"flag",KeyL:"like",KeyM:"move",KeyO:"approve",KeyS:"share",KeyW:"zoom",Period:"select"},keymap:{"create-album":["A",PF.fn._s("Create album")],approve:["O",PF.fn._s("Approve")],close:["Esc",PF.fn._s("Close")],delete:["Del",PF.fn._s("Delete")],edit:["E",PF.fn._s("Edit")],flag:["F",PF.fn._s("Toggle flag")],like:["L",PF.fn._s("Like")],move:["M",PF.fn._n("Move")],next:["►",PF.fn._s("Next")],prev:["◄",PF.fn._s("Previous")],select:[".",PF.fn._s("Toggle select")],share:["S",PF.fn._s("Share")],zoom:["W",PF.fn._s("Zoom")]},loading:null,idleTimer:0,$item:null,show:function(){PF.fn.parseQueryString(this.$item.closest(PF.obj.listing.selectors.content_listing_visible).data("params-hidden"));this.getEl("root").removeClass(this.selectors.rootHide.substring(1)).addClass(this.selectors.rootShow.substring(1)),$("body").addClass(this.selectors.bodyShown.substring(1));var e=new Hammer($(CHV.fn.listingViewer.selectors.root).get(0),{direction:Hammer.DIRECTION_VERTICAL});e.on("swipeleft swiperight",function(e){var t="left"==e.type.substring("swipe".length)?"next":"prev";CHV.fn.listingViewer[t]()}),this.getEl("root")[(PF.fn.isDevice(["phone","phablet"])?"add":"remove")+"Class"]("--over")},getItem:function(){return this.$item},getEl:function(e){var t=!e.startsWith("template")&&!e.startsWith("root")&&this.selectors.root;return t?$(this.selectors[e],t):$(this.selectors[e])},getObject:function(e){if(e||void 0===this.object){var t=decodeURIComponent(this.getItem().attr("data-object"));this.object=JSON&&JSON.parse(t)||$.parseJSON(t)}return this.object},placeholderSizing:function(){if(this.getEl("root").exists()){var e=Math.max(document.documentElement.clientWidth,window.innerWidth||0),t=Math.max(document.documentElement.clientHeight,window.innerHeight||0),a=e/t,o=this.getEl("src")[0],i=o.getAttribute("width"),n=o.getAttribute("height"),r=i/n,s=a<r;o.classList.remove("--width-auto","--height-auto"),o.classList.add("--"+(s?"height":"width")+"-auto")}},filler:function(e){var t=this,a=this.getEl("root");if(e){var o=this.getParsedTemplate();a.html(o.html())}a[(this.getItem().hasClass("selected")?"add":"remove")+"Class"]("selected");var i=["prev","next"];$.each(i,function(e,o){var i=t.selectors["rootNav"+(o.charAt(0).toUpperCase()+o.slice(1).toLowerCase())],n=$(PF.obj.listing.selectors.content_listing_pagination+":visible").length>0?"add":t.getItem()[o]().exists()?"add":"remove";a[n+"Class"](i.substring(1))}),$.each(this.getItem().get(0).attributes,function(e,t){if(!t.name.startsWith("data-"))return!0;a.attr(t.name,t.value)}),a.attr("data-has-owner",void 0===this.object.user?"0":"1");var n=this.getItem().find(".list-item-image-tools[data-action='list-tools']");this.getEl("tools").append(n.html());let r=this;this.getEl("tools").find(".list-tool[data-action]").each(function(){$(this).attr("title",$(this).attr("title")+" ("+r.keymap[$(this).attr("data-action")][0]+")")}),this.placeholderSizing(),this.trickyLoad()},zoom:function(){this.getEl("root").attr("data-cover","1"==this.getEl("root").attr("data-cover")?"0":"1")},remove:function(){this.getEl("root").remove()},getParsedTemplate:function(){var e=this.getObject(!0),t=this.getEl("template").html(),a=t.match(/%(\S+)%/g);a&&$.each(a,function(a,o){var i=o.slice(1,-1).split("."),n=!1;i.map(function(t){var a=!1===n?e:n;"object"==typeof a&&t in a&&(n=a[t])});var r=new RegExp(o,"g");n=void 0===n?"":n,t=t.replace(r,n)});var o=$(t),i=o.find(".viewer-owner--user"),n=i.find(".user-image:not(.default-user-image)");return""!==n.attr("src")&&(n=i.find(".user-image.default-user-image")),n.remove(),o},insertEl:function(){var e=this.getParsedTemplate();this.getEl("rootZero").remove(),e.appendTo("body")},toggleIdle:function(e,t){var a=this;t=void 0===t||t;$("html")[(e?"add":"remove")+"Class"]("--idle"),e||(clearTimeout(a.idleTimer),t&&(a.idleTimer=setTimeout(function(){var e=$(".fullscreen"),t=a.getEl("root");a.toggleIdle(t.length>0&&0==e.length)},5e3)))},open:function(e){if(e.exists()){this.setItem(e),this.insertEl(),this.filler(),this.show(),this.toggleIdle(!1);var t=this;this.getEl("root").on("mousemove mouseout",function(){t.toggleIdle(!1)})}else this.getEl("rootZero").remove()},setItem:function(e){this.$item=e},trickyLoad:function(){if(this.object.image.url!=this.object.display_url){var e=this.getEl("src").parent().html(),t=$(e).attr("src",this.object.image.url);t.insertBefore(this.getEl("src"));var a=t.eq(0),o="video"==a.attr("data-media");o?(a.replaceWith('<video draggable="false" class="viewer-src no-select animate" playsinline autoplay controls src="'+this.object.image.url+'" poster="'+this.object.display_url+'"></video>'),t.next().css("opacity",0),setTimeout(function(){t.next().remove()},200)):a.attr("src",this.object.image.url),t.imagesLoaded(function(){o||t.next().remove()})}},close:function(){var e=this;$(this.selectors.root).removeClass(this.selectors.rootShow.substring(1)).addClass(this.selectors.rootHide.substring(1)),$("body").removeClass(this.selectors.bodyShown.substring(1)),this.toggleIdle(!1,!1),null!==this.getItem()&&$(window).scrollTop(this.getItem().offset().top),$("html").attr("data-scroll-lock","1"),setTimeout(function(){e.remove()},250),setTimeout(function(){$("html").removeAttr("data-scroll-lock")},300)},browse:function(e){var t=this.getItem()[e]();if(t.exists()){this.setItem(t),this.filler(!0);var a=$(PF.obj.listing.selectors.content_listing_visible).find("[data-action=load-more]"),o=t[e+"All"]().length;a.length>0&&o<=5&&!PF.obj.listing.calling&&"next"==e&&a.trigger("click")}else{var i=$("[data-pagination="+e+"]",PF.obj.listing.selectors.content_listing_pagination+":visible"),n=i.attr("href");if(!n)return;window.location.href=n+"&viewer="+e}},prev:function(){this.browse("prev")},next:function(){this.browse("next")}},CHV.obj.image_viewer={selector:"#image-viewer",container:"#image-viewer",navigation:".image-viewer-navigation",loading:"#image-viewer-loading",loader:"#image-viewer-loader"},CHV.obj.image_viewer.$container=$(CHV.obj.image_viewer.container),CHV.obj.image_viewer.$navigation=$(CHV.obj.image_viewer.navigation),CHV.obj.image_viewer.$loading=$(CHV.obj.image_viewer.loading),CHV.fn.system={checkUpdates:function(e){$.ajax({url:CHEVERETO.api.get.info+"/",data:{id:CHEVERETO.id},cache:!1}).always(function(t,a,o){"function"==typeof e&&e(o)})}},("MacIntel"===navigator.platform&&navigator.maxTouchPoints>0||"iPad"===navigator.platform)&&$("html").removeClass("device-nonmobile"),CHV.fn.bindSelectableItems=function(){var e="content-listing-wrapper",t="#"+e;$(t).exists()?$(t).hasClass("ui-selectable")&&$(t).selectable("destroy"):$("#content-listing-tabs").wrap("<div id='"+e+"' />"),$("[data-content=list-selection]").exists()&&$("html.device-nonmobile "+t).selectable({delay:150,filter:PF.obj.listing.selectors.list_item,cancel:".content-empty, .header, #tab-share, #tab-info, .viewer-title, .header-link, .top-bar, .content-listing-pagination *, #fullscreen-modal, #top-user, #background-cover, .list-item-desc, .list-item-image-tools, [data-action=load-image], #tab-embeds",classes:{"ui-selected":"selected"},selected:function(e,t){var a=$(t.selected);CHV.fn.list_editor.selectItem(a)},unselecting:function(e,t){var a=$(t.unselecting);CHV.fn.list_editor.unselectItem(a)}})},CHV.fn.isCachedImage=function(e){var t=new Image;return t.src=e,t.complete||t.width+t.height>0},CHV.fn.viewerLoadImage=function(){if(CHV.obj.image_viewer.$loading.exists()&&(CHV.obj.image_viewer.$loading.removeClass("soft-hidden").css({zIndex:2}),PF.fn.loading.inline(CHV.obj.image_viewer.$loading,{color:"white",size:"small",center:!0,valign:!0}),CHV.obj.image_viewer.$loading.hide().fadeIn("slow")),$(CHV.obj.image_viewer.loader).remove(),CHV.obj.image_viewer.image.is_360)return PF.fn.loading.destroy(CHV.obj.image_viewer.$loading),pannellum.viewer("image-viewer-360",{autoLoad:!0,type:"equirectangular",panorama:CHV.obj.image_viewer.image.url,preview:CHV.obj.image_viewer.$container.find(".media").eq(0).attr("src"),pitch:2.3,yaw:-135.4,hfov:120}),$("#image-viewer-360").removeClass("soft-hidden"),void CHV.obj.image_viewer.$container.find(".media").eq(0).remove();CHV.obj.image_viewer.image.html=CHV.obj.image_viewer.$container.html(),CHV.obj.image_viewer.$container.css("height",CHV.obj.image_viewer.$container.height()).prepend($(CHV.obj.image_viewer.image.html).css({top:0,zIndex:0,opacity:0,position:"absolute"})),CHV.obj.image_viewer.$container.find(".media").eq(0).css("zIndex",1);var e=CHV.obj.image_viewer.$container.find(".media").eq(1),t=e.css("width"),a=e.css("height");"video"===e.attr("data-media")?(e.replaceWith('<video class="media animate" controls autoplay playsinline width="'+t+'" height="'+a+'" src="'+CHV.obj.image_viewer.image.url+'" poster="'+CHV.obj.image_viewer.image.display_url+'" style="opacity: 0;"></video>'),e.src=CHV.obj.image_viewer.image.url):e.attr("src",CHV.obj.image_viewer.image.url),e.imagesLoaded(function(){CHV.obj.image_viewer.$container.find(".media").eq(1).css({position:"",display:"",opacity:1}),CHV.obj.image_viewer.$container.find(".media").eq(0).remove(),$(CHV.obj.image_viewer.container).css("height",""),PF.fn.loading.destroy(CHV.obj.image_viewer.$loading)})},CHV.obj.embed_share_tpl={},CHV.obj.embed_upload_tpl={},CHV.obj.topBar={transparencyScrollToggle:function(){var e=$(window).scrollTop();$("#top-bar")[(e>0?"remove":"add")+"Class"]("transparent")}},CHV.obj.uploaderReset={isUploading:!1,canAdd:!0,queueStatus:"ready",uploadThreads:0,uploadParsedIds:[],uploadProcessedIds:[],files:{},results:{success:{},error:{}},toggleWorking:0,filesAddId:0,clipboardImages:[]},CHV.fn.uploader={files:{},selectors:{root:"#anywhere-upload",show:".upload-box--show",queue:"#anywhere-upload-queue",queue_complete:".queue-complete",queue_item:".queue-item",close_cancel:"[data-button=close-cancel]",file:"#anywhere-upload-input",camera:"#anywhere-upload-input-camera",upload_item_template:"#anywhere-upload-item-template",item_progress_bar:"[data-content=progress-bar]",failed_result:"[data-content=failed-upload-result]",fullscreen_mask:"#fullscreen-uploader-mask",dropzone:"#uploader-dropzone",paste:"#anywhere-upload-paste",input:"[data-action=anywhere-upload-input]"},toggle:function(e,t){this.queueSize();var a=$("[data-action=top-bar-upload]",".top-bar"),o=!$(CHV.fn.uploader.selectors.root).data("shown");e=$.extend({callback:null,reset:!0},e);if(void 0!==e.show&&e.show&&(o=!0),PF.fn.growl.close(!0),PF.fn.close_pops(),!(1==this.toggleWorking||$(CHV.fn.uploader.selectors.root).is(":animated")||CHV.fn.uploader.isUploading||a.data("login-needed")&&!PF.fn.is_user_logged())){this.toggleWorking=1;var i={time:500,easing:null},n=function(){!o&&e.reset&&CHV.fn.uploader.reset(),PF.fn.topMenu.hide(),"function"==typeof e.callback&&e.callback(t),CHV.fn.uploader.boxSizer(),CHV.fn.uploader.toggleWorking=0};if($(CHV.fn.uploader.selectors.root)[(o?"add":"remove")+"Class"](this.selectors.show.substring(1)),o){if($("html").data({"followed-scroll":$("html").hasClass("followed-scroll"),"top-bar-box-shadow-prevent":!0}).removeClass("followed-scroll").addClass("overflow-hidden top-bar-box-shadow-none"),$("#top-bar").data({stock_classes:$("#top-bar").attr("class")}).addClass("scroll-up"),$(".current[data-nav]",".top-bar").each(function(){$(this).is("[data-action=top-bar-menu-full]")||$(this).removeClass("current").attr("data-current",1)}),PF.fn.isDevice("mobile")){var r=$(".upload-box-heading",$(CHV.fn.uploader.selectors.root));r.css({position:"relative",top:.5*($(window).height()-r.height())+"px"})}CHV.fn.uploader.focus(function(){setTimeout(function(){n()},i.time)})}else{$("#top-bar")[0].className=$("#top-bar").data("stock_classes"),$("[data-nav][data-current=1]",".top-bar").each(function(){$(this).addClass("current")}),setTimeout(function(){$(CHV.fn.uploader.selectors.fullscreen_mask).css({opacity:0})},.1*i.time),setTimeout(function(){$(CHV.fn.uploader.selectors.fullscreen_mask).remove()},i.time);var s=$(CHV.fn.uploader.selectors.root).outerHeight(),l=s-parseInt($(CHV.fn.uploader.selectors.root).data("initial-height"))+"px";$(CHV.fn.uploader.selectors.root).css({transform:"translate(0,-"+l+")"}),setTimeout(function(){$(CHV.fn.uploader.selectors.root).css({top:""}),n(),$("html,body").removeClass("overflow-hidden").data({"top-bar-box-shadow-prevent":!1}),$("#top-bar *").trigger("blur")},i.time)}$(CHV.fn.uploader.selectors.root).data("shown",o),a.toggleClass("current").removeClass("opened")}},reset:function(){$.extend(this,$.extend(!0,{},CHV.obj.uploaderReset)),$("li",this.selectors.queue).remove(),$(this.selectors.root).height("").css({"overflow-y":"","overflow-x":""}),$(this.selectors.queue).addClass("queueEmpty").removeClass(this.selectors.queue_complete.substring(1)),$(this.selectors.input,this.selectors.root).each(function(){$(this).prop("value",null)}),$("[data-group=upload-result] textarea",this.selectors.root).prop("value",""),$.each(["upload-queue-ready","uploading","upload-result","upload-queue-ready","upload-queue"],function(e,t){$("[data-group="+t+"]").hide()}),$("[data-group=upload]",this.selectors.root).show(),$("[name=upload-album-id]",this.selectors.root).prop("value",function(){var e=$("option[selected]",this);if(e.exists())return e.attr("value")}),$(this.selectors.root).removeClass("queueCompleted queueReady queueHasResults").addClass("queueEmpty").attr("data-queue-size",0),$("[name=upload-category-id]",this.selectors.root).prop("value",""),$("[name=upload-nsfw]",this.selectors.root).prop("checked",this.defaultChecked),this.boxSizer(!0)},focus:function(e){$(this.selectors.fullscreen_mask).exists()||($("body").is("#upload")||$("body").append($("<div/>",{id:this.selectors.fullscreen_mask.replace("#",""),class:"fullscreen black"}).css({top:PF.fn.isDevice("phone")?0:$(CHV.fn.uploader.selectors.root).data("top")})),setTimeout(function(){$("body").is("#upload")||$(CHV.fn.uploader.selectors.fullscreen_mask).css({opacity:1}),setTimeout(function(){"function"==typeof e&&e()},PF.fn.isDevice(["phone","phablet"])?0:250)},1))},boxSizer:function(e){var t=$(this.selectors.root).is(this.selectors.show),a=t||e;t&&$("html").addClass("overflow-hidden"),a&&($(this.selectors.root).height(""),!$("body").is("#upload")&&$(this.selectors.root).height()>$(window).height()?($(this.selectors.root).height($(window).height()-$("#top-bar").height()).css({"overflow-y":"scroll","overflow-x":"auto"}),$("html").addClass("overflow-hidden")):$(this.selectors.root).css("overflow-y",""))},pasteURL:function(){var e=$("[name=urls]",PF.obj.modal.selectors.root),t=e.val();t&&(CHV.fn.uploader.toggle({show:!0}),CHV.fn.uploader.add({},t))},pasteImageHandler:function(e){if(!$(e.target).is(":input")){if(void 0!==e.clipboardData&&e.clipboardData.items)var t=e.clipboardData.items;else setTimeout(function(){return e.clipboardData={},e.clipboardData.items=[],$.each($("img",CHV.fn.uploader.$pasteCatcher),function(t,a){e.clipboardData.items.push(PF.fn.dataURItoBlob($(this).attr("src")))}),$(CHV.fn.uploader.selectors.paste).html(""),CHV.fn.uploader.pasteImageHandler(e)},1);if(t){const e=new Array,i=new Array,n=new RegExp("^(image|video)/","i");let r=$(CHV.fn.uploader.selectors.root).data("shown");for(var a=0;a<t.length;a++)if(n.test(t[a].type)){let o=t[a].getAsFile();e.push(o)}else if("string"==t[a].kind){if(!CHV.obj.config.upload.url)continue;t[a].getAsString(function(e){CHV.fn.uploader.add({},e)}),i.push(a)}if(0==e.length&&0==i.length)return;var o={originalEvent:{dataTransfer:{files:[...e]},preventDefault:function(){},stopPropagation:function(){}}};r?CHV.fn.uploader.add(o):CHV.fn.uploader.toggle({callback:function(){CHV.fn.uploader.add(o)}})}}},add:function(e,t){function a(e,t,o,i){if(e.isDirectory){var n=e.createReader();n.readEntries(function(e){var i=e.length,n=0;e.forEach(function(e){n++,".DS_Store"!==e.name&&a(e,t,o,i===n)})}),o.push(e.name)}else e.file(function(e){t.push(e),i&&CHV.fn.uploader.add({originalEvent:{preventDefault:function(){},stopPropagation:function(){},dataTransfer:{parsedItems:!0,files:[...t]}}})})}function o(e){if(void 0===e)e=0;if(e in s){var t=s[e];l.includes(t.name)||($(CHV.fn.uploader.selectors.queue_item+":not([data-id]) .load-url",CHV.fn.uploader.selectors.queue)[void 0!==t.url?"show":"remove"](),loadImage.parseMetaData(t.url?t.url:t,function(a){function i(e){return $(CHV.fn.uploader.selectors.queue_item+"[data-id="+e+"]",CHV.fn.uploader.selectors.queue)}function n(){$("[data-group=upload-queue]",CHV.fn.uploader.selectors.root).is(":visible")||$("[data-group=upload-queue]",CHV.fn.uploader.selectors.root).css("display","block")}function r(e){var t=null;if(void 0!==e.name){var a=PF.fn.baseName(e.name);t=$.trim(a.substring(0,100).capitalizeFirstLetter())}return t}function l(e,t){const a=document.createElement("video");a.onerror=(e=>{const o={1:"MEDIA_ERR_ABORTED",2:"MEDIA_ERR_NETWORK",3:"MEDIA_ERR_DECODE",4:"MEDIA_ERR_SRC_NOT_SUPPORTED"};var i=o[a.error.code];t({type:"error",error:i}),console.error("Error loading video",i)}),a.addEventListener("loadedmetadata",function(){const e=parseInt(a.duration/4);setTimeout(()=>{a.currentTime=e,a.pause()},200),a.addEventListener("seeked",()=>{const e=document.createElement("canvas");e.width=a.videoWidth,e.height=a.videoHeight;const o=e.getContext("2d");o.drawImage(a,0,0,e.width,e.height),o.canvas.toBlob(o=>{t(a,e)},"image/jpeg",.9)},!1)}),/iPad|iPhone|iPod|Safari/.test(navigator.userAgent)&&(a.autoplay=!0,a.playsInline=!0,a.muted=!0),a.preload="metadata",a.src=e}function d(e,t){e.show(),$(CHV.fn.uploader.selectors.root).addClass("queueReady").removeClass("queueEmpty"),$("[data-group=upload-queue-ready]",CHV.fn.uploader.selectors.root).show(),$("[data-group=upload]",CHV.fn.uploader.selectors.root).hide(),e.find(".load-url").remove(),e.find(".preview").removeClass("soft-hidden").show().append(t),$img=e.find(".preview").find("img,canvas"),$img.attr("class","canvas"),queue_item_h=e.height(),queue_item_w=e.width();var a=parseInt($img.attr("width"))||$img.width(),o=parseInt($img.attr("height"))||$img.height(),i=a/o;if($img.hide(),a>o||a==o){var r=o<queue_item_h?o:queue_item_h;a>o&&$img.height(r).width(r*i)}if(a<o||a==o){var s=a<queue_item_w?a:queue_item_w;a<o&&$img.width(s).height(s/i)}a==o&&$img.height(r).width(s),$img.css({marginTop:-$img.height()/2,marginLeft:-$img.width()/2}).show(),n(),CHV.fn.uploader.boxSizer()}function c(e,t,a){if(e===t.length){if(void 0!==C&&(a=a.concat(C)),PF.fn.loading.destroy("fullscreen"),a.length>0){for(var o="",i=0;i<a.length;i++)o+="<li>"+PF.fn.htmlEncode(a[i].name)+" - "+PF.fn.htmlEncode(a[i].error)+"</li>",delete CHV.fn.uploader.files[a[i].uid],$("li[data-id="+a[i].uid+"]",CHV.fn.uploader.selectors.queue).find("[data-action=cancel]").click();PF.fn.modal.simple({title:PF.fn._s("Some files couldn't be loaded"),message:"<ul>"+o+"</ul>"})}else CHV.fn.uploader.focus();CHV.fn.uploader.boxSizer()}}if($(CHV.fn.uploader.selectors.queue_item+":not([data-id]) .preview:empty",CHV.fn.uploader.selectors.queue).first().closest("li").attr("data-id",t.uid),void 0!==t.type&&t.type.startsWith("video/")){var u=i(t.uid),m=r(t),p=URL.createObjectURL(t);l(p,function(e,a){++w,"error"===e.type?f.push({uid:t.uid,name:t.name.truncate_middle(),error:e.error}):(CHV.fn.uploader.files[t.uid].parsedMeta={title:m,width:e.videoWidth,height:e.videoHeight,mimetype:t.type},d(u,a)),c(w,s,f)})}else loadImage(t.url?t.url:t,function(e,o){++w;var l=i(t.uid);if("error"===e.type)f.push({uid:t.uid,name:t.name.truncate_middle(),error:"MEDIA_ERR_SRC_FORMAT"});else{n();var u="image/jpeg";if(t.hasOwnProperty("type")?u=t.type:t.type=u,void 0!==a.buffer){for(var m=new Uint8Array(a.buffer).subarray(0,4),p="",g=0;g<m.length;g++)p+=m[g].toString(16);var h={"89504e47":"image/png",47494638:"image/gif",ffd8ffe0:"image/jpeg",ffd8ffe1:"image/jpeg",ffd8ffe2:"image/jpeg",ffd8ffe3:"image/jpeg",ffd8ffe8:"image/jpeg"};void 0!==h[p]&&(u=h[p])}var v=r(t);CHV.fn.uploader.files[t.uid].parsedMeta={title:v,width:o.originalWidth,height:o.originalHeight,mimetype:u},d(l,e)}c(w,s,f)},$.extend({},H,{orientation:a.exif?a.exif.get("Orientation"):1}));setTimeout(function(){o(e+1)},25)}))}else PF.fn.loading.destroy("fullscreen")}var i;if(!this.canAdd){e=e.originalEvent;return e.preventDefault(),e.stopPropagation(),!1}var n=$(this.selectors.file);n.replaceWith(n=n.clone(!0));var r=$(this.selectors.upload_item_template).html();let s=[],l=[];if(void 0===t){e=e.originalEvent;e.preventDefault(),e.stopPropagation();var d=e.dataTransfer||e.target;if("items"in d)for(var c=d.items,u=0;u<c.length;u++){var m=c[u].webkitGetAsEntry();m&&a(m,s,l,!1)}"files"in d&&(s=Array.isArray(d.files)?d.files.slice():$.makeArray(d.files),s=s.filter(function(e){return l.indexOf(e.name)<0}));var f=[];for(u=0;u<s.length;u++){var p,g=s[u];if(!l.includes(g.name))p=void 0===g.type||""==g.type?g.name.substr(g.name.lastIndexOf(".")+1).toLowerCase():g.type.replace("image/","").replace("video/",""),g.size>CHV.obj.config.image.max_filesize.getBytes()?f.push({uid:u,name:g.name.truncate_middle()+" - "+PF.fn._s("File too big."),error:"MEDIA_ERR_FILE_SIZE"}):-1!=CHV.obj.config.upload.image_types.indexOf(p)||0!=/android/i.test(navigator.userAgent)?(i&&(g.md5=i),g.fromClipboard=1==e.clipboard,g.uid=u):f.push({uid:u,name:g.name.truncate_middle()+" - "+PF.fn._s("Invalid or unsupported file format."),error:"MEDIA_ERR_FILETYPE"})}for(u=0;u<f.length;u++){var h=f[u];s.splice(h.id,1)}if(f.length>0&&0==s.length){var v="";for(u=0;u<f.length;u++)v+="<li>"+PF.fn.htmlEncode(f[u].name)+"</li>";return void PF.fn.modal.simple({title:PF.fn._s("Some files couldn't be added"),message:"<ul><li>"+v+"</ul>"})}if(0==s.length)return}else{if(t=t.replace(/(<([^>]+)>)/g,"").replace(/(\[([^\]]+)\])/g,""),s=t.match_urls(),!s)return;s=s.array_unique(),s=$.map(s,function(e,t){return{uid:t,name:e,url:e}})}if($.isEmptyObject(this.files))for(u=0;u<s.length;u++)this.files[s[u].uid]=s[u],this.filesAddId++;else{var b=[];for(var _ in this.files)void 0!==this.files[_]&&"function"!=typeof this.files[_]&&b.push(encodeURI(this.files[_].name));s=$.map(s,function(e,t){return-1!=$.inArray(encodeURI(e.name),b)?null:(e.uid=CHV.fn.uploader.filesAddId,CHV.fn.uploader.filesAddId++,e)});for(u=0;u<s.length;u++)this.files[s[u].uid]=s[u]}$(this.selectors.queue,this.selectors.root).append(r.repeat(s.length)),$(this.selectors.queue+" "+this.selectors.queue_item+":not([data-id])",this.selectors.root).hide();var C=f,w=(f=[],0),H={canvas:!0,maxWidth:610};PF.fn.loading.fullscreen(),o(),this.queueSize()},queueSize:function(){$(this.selectors.root).attr("data-queue-size",Object.size(this.files)),$("[data-text=queue-objects]",this.selectors.root).text(PF.fn._n("file","files",Object.size(this.files))),$("[data-text=queue-size]",this.selectors.root).text(Object.size(this.files))},queueProgress:function(e,t){var a=Object.size(this.files);this.files[t].progress=e.loaded/e.total;for(var o=0,i=0;i<a;i++)void 0!==this.files[i]&&"progress"in this.files[i]&&(o+=this.files[i].progress);$("[data-text=queue-progress]",this.selectors.root).text(parseInt(100*o/a))},upload:function(e){var t=e.data("id"),a=!!e.next().exists()&&e.next().data("id");if(-1===$.inArray(t,this.uploadParsedIds)){var o=this;this.uploadParsedIds.push(t);var i=this.files[t];if(void 0!==i){var n=void 0!==i.url,r=n?i.url:i,s=void 0!==i.formValues;if(void 0!==i){this.uploadThreads+=1,this.uploadThreads<CHV.obj.config.upload.threads&&a&&this.upload(e.next()),this.isUploading=!0;var l=new FormData,d={source:null,type:n?"url":"file",action:"upload",privacy:$("[data-privacy]",this.selectors.root).first().data("privacy"),timestamp:this.timestamp,auth_token:PF.obj.config.auth_token,expiration:$("[name=upload-expiration]",this.selectors.root).val()||"",category_id:$("[name=upload-category-id]",this.selectors.root).val()||null,nsfw:$("[name=upload-nsfw]",this.selectors.root).prop("checked")?1:0,album_id:$("[name=upload-album-id]",this.selectors.root).val()||null,mimetype:i.type};n?d.source=r:l.append("source",r,i.name),s&&$.each(i.formValues,function(e,t){d[e.replace(/image_/g,"")]=t}),$.each(d,function(e,t){if(null===t)return!0;l.append(e,t)}),this.files[t].xhr=new XMLHttpRequest,e.removeClass("waiting"),$(".block.edit, .queue-item-button.edit",e).remove(),n?(this.queueSize(),this.queueProgress({loaded:1,total:1},t),this.itemLoading(e)):this.files[t].xhr.upload.onprogress=function(a){a.lengthComputable&&(CHV.fn.uploader.queueProgress(a,t),percentComplete=parseInt(a.loaded/a.total*100),$(CHV.fn.uploader.selectors.item_progress_bar,e).width(100-percentComplete+"%"),100==percentComplete&&CHV.fn.uploader.itemLoading(e))},this.files[t].xhr.onreadystatechange=function(){var i=!1;if(4==this.readyState&&void 0!==CHV.fn.uploader.files[t].xhr&&0!==CHV.fn.uploader.files[t].xhr.status){o.uploadProcessedIds.push(t),o.uploadThreads-=1,$(".loading-indicator",e).remove(),e.removeClass("waiting uploading");try{var n="json"!==this.responseType?JSON.parse(this.response):this.response;void 0!==n&&200==this.status?$("[data-group=image-link]",e).attr("href",n.image.path_viewer):("PDOException"==n.error.context&&(n.error.message="Database error"),n.error.message=PF.fn.htmlEncode(CHV.fn.uploader.files[t].name.truncate_middle())+" - "+n.error.message),CHV.fn.uploader.results[200==this.status?"success":"error"][t]=n,200!==this.status&&(i=!0)}catch(e){var r;i=!0,r=void 0===n?{status:500,statusText:"Internal server error"}:{status:400,statusText:n.error.message},n={status_code:r.status,error:{message:PF.fn.htmlEncode(CHV.fn.uploader.files[t].name.truncate_middle())+" - Server error ("+r.statusText+")",code:r.status,context:"XMLHttpRequest"},status_txt:r.statusText};var s=Object.size(CHV.fn.uploader.results.error)+1;CHV.fn.uploader.results.error[s]=n}e.addClass(i?"failed":"completed"),void 0!==n.error&&void 0!==n.error.message&&(e.attr("rel","tooltip").data("tiptip","top").attr("title",n.error.message),PF.fn.bindtipTip(e)),o.uploadThreads<CHV.obj.config.upload.threads&&a&&(CHV.fn.uploader.upload(e.next()),$(CHV.fn.uploader.selectors.root).addClass("queueHasResults")),o.uploadProcessedIds.length==Object.size(o.files)&&CHV.fn.uploader.displayResults(),$(".done",e).fadeOut()}},this.files[t].xhr.open("POST",PF.obj.config.json_api,!0),this.files[t].xhr.setRequestHeader("Accept","application/json"),this.files[t].xhr.send(l)}else e.next().exists()&&this.upload(e.next())}}else e.next().exists()&&this.upload(e.next())},itemLoading:function(e){PF.fn.loading.inline($(".progress",e),{color:"#FFF",size:"normal",center:!0,position:"absolute",shadow:!0}),$("[data-action=cancel], [data-action=edit]",e).hide()},displayResults:function(){CHV.fn.uploader.isUploading=!1;for(var e="[data-group=upload-result][data-result=%RESULT%]",t=["error","mixed","success"],a={},o=0;o<t.length;o++)a[t[o]]=e.replace("%RESULT%",t[o]);if(Object.size(this.results.error)>0){var i=[];for(var o in this.results.error)"object"==typeof this.results.error[o]&&(i[o]=this.results.error[o].error.message);i.length>0&&$(this.selectors.failed_result).html("<li>"+i.join("</li><li>")+"</li>")}else $(a.error,this.selectors.root).hide();if(!window.opener&&0==CHV.obj.config.upload.moderation&&CHV.obj.config.upload.redirect_single_upload&&1==Object.size(this.results.success)&&0==Object.size(this.results.error))return window.location.href=this.results.success[Object.keys(this.results.success)[0]].image.path_viewer,!1;if($("[data-text=queue-progress]",this.selectors.root).text(100),$("[data-group=uploading]",this.selectors.root).hide(),$(this.selectors.root).removeClass("queueUploading queueHasResults").addClass("queueCompleted"),$(this.selectors.queue).addClass(this.selectors.queue_complete.substring(1)),Object.size(this.results.success)>0&&$("[data-group=upload-result] textarea",this.selectors.root).exists()&&CHV.fn.fillEmbedCodes(this.results.success,CHV.fn.uploader.selectors.root,"val"),Object.size(this.results.success)>0&&Object.size(this.results.error)>0?$(a.mixed+", "+a.success,this.selectors.root).show():Object.size(this.results.success)>0?$(a.success,this.selectors.root).show():Object.size(this.results.error)>0&&$(a.error,this.selectors.root).show(),$(a.success,this.selectors.root).is(":visible")){
$(a.success,this.selectors.root).find("[data-group^=user], [data-group=guest]").hide(),$(a.success,this.selectors.root).find("[data-group="+(PF.fn.is_user_logged()?"user":"guest")+"]").show();var n=Object.keys(this.results.success)[0];if(void 0!==this.results.success[n].image.album){var r=[];for(var s in this.results.success){var l=this.results.success[s].image;l.album&&l.album.id_encoded&&-1==r.indexOf(l.album.id_encoded)&&r.push(l.album.id_encoded)}var d={link:null,text:null};if(r.length<=1?(d.link=this.results.success[n].image.album.url,d.text=this.results.success[n].image.album.name):(d.link=this.results.success[n].image.user.url_albums,d.text=PF.fn._s("%s's Albums",this.results.success[n].image.user.name_short_html)),$("[data-text=upload-target]",this.selectors.root).text(d.text),$("[data-link=upload-target]",this.selectors.root).attr("href",d.link),PF.fn.is_user_logged()){var c=r.length>0?"album":"stream";$("[data-group=user-"+c+"]",this.selectors.root).show()}}}if(this.boxSizer(),this.queueStatus="done",window.opener&&void 0!==CHV.obj.opener.uploadPlugin[window.name]){if(CHV.obj.opener.uploadPlugin[window.name].autoInsert){var u=CHV.obj.opener.uploadPlugin[window.name].autoInsert,m=$(':input[name="'+u+'"]',CHV.fn.uploader.selectors.root),f=m.val();f&&window.opener.postMessage({id:window.name,message:f},"*")}CHV.obj.opener.uploadPlugin[window.name].autoClose&&window.close()}else $('[data-action="openerPostMessage"]',this.selectors.root).remove()}},$.extend(CHV.fn.uploader,$.extend(!0,{},CHV.obj.uploaderReset)),CHV.fn.fillEmbedCodes=function(e,t,a){void 0===a&&(a="val");var o=CHV.fn.uploader.selectors.root==t?"embed_upload_tpl":"embed_share_tpl",i=!1,n=!1,r=!1;$.each(e,function(e,s){if(void 0===s)return;var l="id_encoded"in s?s:s.image,d=Object.flatten(l);let c=""!==l.url_frame,u=null!==l.medium.url,m=null!==l.thumb.url;c&&(i=!0),u&&(n=!0),m&&(r=!0),$.each(CHV.obj[o],function(e,o){$.each(o.options,function(e,o){if(!c&&e.startsWith("frame-"))return;if(!u&&e.startsWith("medium-"))return;if(!m&&e.startsWith("thumb-"))return;var i=$("textarea[name="+e+"]",t),n=o.template;for(var r in"object"==typeof n&&n.hasOwnProperty(d.type)&&(n=n[d.type]),"video"!==d.type&&(n=n.replaceAll("%URL_FRAME%","")),d)d.hasOwnProperty(r)&&(n=n.replace(new RegExp("%"+r.toUpperCase()+"%","g"),PF.fn.htmlEncode(PF.fn.htmlEncode(d[r]))));let s="thumb"==i.data("size")&&"thumb-links"!==e;i[a](i.val()+n+(s?" ":"\n"))})})}),$("option[value^=frame]",t).prop("disabled",!i),$("option[value^=medium-]",t).prop("disabled",!n),$("option[value^=thumb-]",t).prop("disabled",!r),$.each(CHV.obj[o],function(e,o){$.each(o.options,function(e,o){var i=$("textarea[name="+e+"]",t);i[a]($.trim(i.val()))})})},CHV.fn.resource_privacy_toggle=function(e){CHV.obj.resource.privacy=e,e||(e="public"),$("[data-content=privacy-private]").hide(),"public"!==e&&$("[data-content=privacy-private]").show()},CHV.fn.submit_create_album=function(){var e=$(PF.obj.modal.selectors.root);return""==$("[name=form-album-name]",e).val()?(PF.fn.growl.call(PF.fn._s("You must enter the album name.")),$("[name=form-album-name]",e).highlight(),!1):(PF.obj.modal.form_data={action:"create-album",type:"album",owner:CHV.obj.resource.user.id,album:{parent_id:$("[name=form-album-parent-id]",e).val(),name:$("[name=form-album-name]",e).val(),description:$("[name=form-album-description]",e).val(),privacy:$("[name=form-privacy]",e).val(),password:"password"==$("[name=form-privacy]",e).val()?$("[name=form-album-password]",e).val():null,new:!0}},!0)},CHV.fn.complete_create_album={success:function(e){var t=e.responseJSON.album;window.location=t.url},error:function(e){var t=e.responseJSON;PF.fn.growl.call(PF.fn._s(t.error.message))}},CHV.fn.submit_upload_edit=function(){var e=$(PF.obj.modal.selectors.root),t=!1;return $("[data-content=form-new-album]",e).is(":visible")&&""==$("[name=form-album-name]",e).val()?(PF.fn.growl.call(PF.fn._s("You must enter the album name.")),$("[name=form-album-name]",e).highlight(),!1):($("[data-content=form-new-album]",e).is(":visible")&&(t=!0),PF.obj.modal.form_data={action:t?"create-album":"move",type:"images",album:{ids:$.map(CHV.fn.uploader.results.success,function(e){return e.image.id_encoded}),new:t}},t?(PF.obj.modal.form_data.album.name=$("[name=form-album-name]",e).val(),PF.obj.modal.form_data.album.description=$("[name=form-album-description]",e).val(),PF.obj.modal.form_data.album.privacy=$("[name=form-privacy]",e).val(),"password"==PF.obj.modal.form_data.album.privacy&&(PF.obj.modal.form_data.album.password=$("[name=form-album-password]",e).val())):PF.obj.modal.form_data.album.id=$("[name=form-album-id]",e).val(),!0)},CHV.fn.complete_upload_edit={success:function(e){var t=e.responseJSON.album;window.location=t.url},error:function(e){var t=e.responseJSON;PF.fn.growl.call(PF.fn._s(t.error.message))}},CHV.fn.before_image_edit=function(){var e=$("[data-ajax-deferred='CHV.fn.complete_image_edit']");$("[data-content=form-new-album]",e).hide(),$("#move-existing-album",e).show()},CHV.fn.submit_image_edit=function(){var e=$(PF.obj.modal.selectors.root),t=!1;return $("[data-content=form-new-album]",e).is(":visible")&&""==$("[name=form-album-name]",e).val()?(PF.fn.growl.call(PF.fn._s("You must enter the album name.")),$("[name=form-album-name]",e).highlight(),!1):($("[data-content=form-new-album]",e).is(":visible")&&(t=!0),PF.obj.modal.form_data={action:"edit",edit:"image",editing:{id:CHV.obj.resource.id,tags:$("[name=form-image-tags]",e).val()||"",category_id:$("[name=form-category-id]",e).val()||null,title:$("[name=form-image-title]",e).val()||null,description:$("[name=form-image-description]",e).val()||null,nsfw:$("[name=form-nsfw]",e).prop("checked")?1:0,new_album:t}},t?(PF.obj.modal.form_data.editing.album_privacy=$("[name=form-privacy]",e).val(),"password"==PF.obj.modal.form_data.editing.album_privacy&&(PF.obj.modal.form_data.editing.album_password=$("[name=form-album-password]",e).val()),PF.obj.modal.form_data.editing.album_name=$("[name=form-album-name]",e).val(),PF.obj.modal.form_data.editing.album_description=$("[name=form-album-description]",e).val()):PF.obj.modal.form_data.editing.album_id=$("[name=form-album-id]",e).val(),!0)},CHV.fn.complete_image_edit={success:function(e){var t=e.responseJSON.image;if(t.album.id_encoded||(t.album.id_encoded=""),CHV.obj.image_viewer.album.id_encoded!==t.album.id_encoded){CHV.obj.image_viewer.album.id_encoded=t.album.id_encoded;var a={html:t.album.slice&&t.album.slice.html?t.album.slice.html:null,prev:t.album.slice&&t.album.slice.prev?t.album.slice.prev:null,next:t.album.slice&&t.album.slice.next?t.album.slice.next:null};$("[data-content=album-slice]").html(a.html),$("[data-content=album-panel-title]")[a.html?"show":"hide"](),$("a[data-action=prev]").attr("href",a.prev),$("a[data-action=next]").attr("href",a.next),$("a[data-action]",".image-viewer-navigation").each(function(){$(this)[void 0===$(this).attr("href")?"addClass":"removeClass"]("hidden")})}CHV.fn.resource_privacy_toggle(t.album.privacy),$.each(["description","title"],function(e,a){var o=$("[data-text=image-"+a+"]");o.html(PF.fn.nl2br(PF.fn.htmlEncode(t[a]))),""!==o.html()&&o.show()});var o=$("[data-template=tag]").html(),i=t.tags,n="";$.each(i,function(e,t){n+=o.replaceAll("%url",t.url).replaceAll("%tag",t.name_safe_html)}),$("[data-content=tags]").attr("data-count",i.length).find(".tag").remove(),$("[data-content=tags]").append(n),CHV.fn.common.updateDoctitle(t.title),CHV.fn.list_editor.addAlbumtoModals(t.album);var r=$("[data-submit-fn='CHV.fn.submit_image_edit']");$.each(["description","name","password"],function(e,t){var a=$("[name=form-album-"+t+"]",r);a.is("textarea")?a.val("").html(""):a.val("").attr("value","")}),$("[name=form-privacy] option",r).each(function(){$(this).removeAttr("selected")}),$("[data-combo-value=password]",r).hide(),$("[name=form-album-id]",r).find("option").removeAttr("selected"),$("[name=form-album-id]",r).find('[value="'+t.album.id_encoded+'"]').attr("selected",!0)}},CHV.fn.albumEdit={before:function(){var e="[data-before-fn='CHV.fn.albumEdit.before']";$("[data-action=album-switch]",e).remove();var t=$(CHV.fn.ctaForm.selectors.enable,e);CHV.fn.ctaForm.destroy(),CHV.fn.ctaForm.enable&&t.prop("checked",!0).trigger("change")},load:function(){var e=$(CHV.fn.ctaForm.selectors.enable,PF.obj.modal.selectors.root);e.is(":checked")&&e.prop("checked",!0).trigger("change")},submit:function(){var e=$(PF.obj.modal.selectors.root);return $("[name=form-album-name]",e).val()?(PF.obj.modal.form_data={action:"edit",edit:"album",editing:{id:CHV.obj.resource.id,name:$("[name=form-album-name]",e).val(),privacy:$("[name=form-privacy]",e).val(),description:$("[name=form-album-description]",e).val(),cta_enable:+CHV.fn.ctaForm.enable,cta:JSON.stringify(CHV.fn.ctaForm.array)}},"password"==PF.obj.modal.form_data.editing.privacy&&(PF.obj.modal.form_data.editing.password=$("[name=form-album-password]",e).val()),!0):(PF.fn.growl.call(PF.fn._s("You must enter the album name.")),$("[name=form-album-name]",e).highlight(),!1)},complete:{success:function(e){var t=e.responseJSON.album;$("[data-text=album-name]").html(PF.fn.htmlEncode(t.name)),$("[data-text=album-description]").html(PF.fn.htmlEncode(t.description)),CHV.fn.resource_privacy_toggle(t.privacy);var a=CHV.obj.resource.type;CHV.obj.resource.type=null,CHV.fn.list_editor.updateItem($(PF.obj.listing.selectors.list_item,PF.obj.listing.selectors.content_listing_visible),e.responseJSON),CHV.obj.resource.type=a,$("[data-modal]").each(function(){$('option[value="'+t.id_encoded+'"]',this).text(t.name+("public"!==t.privacy?" ("+PF.fn._s("private")+")":""))}),CHV.fn.common.updateDoctitle(t.name),CHV.fn.ctaButtons.render(t.cta_html)}}},CHV.fn.category={formFields:["id","name","url_key","description"],validateForm:function(e){var t=PF.obj.modal.selectors.root,a=!1;return!!CHV.fn.common.validateForm(t)&&(Object.size(CHV.obj.categories)>0&&$.each(CHV.obj.categories,function(o,i){return void 0!==e&&i.id==e||(i.url_key==$("[name=form-category-url_key]",t).val()?(a=!0,!1):void 0)}),!a||(PF.fn.growl.call(PF.fn._s("Category URL key already being used.")),$("[name=form-category-url_key]",t).highlight(),!1))},edit:{before:function(e){var t=$(e.target),a=t.data("category-id"),o=CHV.obj.categories[a],i="[data-modal="+t.data("target")+"]";$.each(CHV.fn.category.formFields,function(e,t){e="form-category-"+t,t=o[t];var a=$("[name="+e+"]",i);a.is("textarea")?a.html(PF.fn.htmlEncode(t)):a.attr("value",t)})},submit:function(){var e=PF.obj.modal.selectors.root,t=$("[name=form-category-id]",e).val();return!!CHV.fn.category.validateForm(t)&&(PF.obj.modal.form_data={action:"edit",edit:"category",editing:{}},$.each(CHV.fn.category.formFields,function(t,a){PF.obj.modal.form_data.editing[a]=$("[name=form-category-"+a+"]",e).val()}),!0)},complete:{success:function(e){var t=e.responseJSON.category,a="[data-content=category]",o="[data-category-id="+t.id+"]";a+=o;$.each(t,function(e,t){$("[data-content=category-"+e+"]",a).html(PF.fn.htmlEncode(t))}),$("[data-link=category-url]",a).each(function(){$(this).attr("href",t.url)}),CHV.obj.categories[t.id]=t}}},delete:{before:function(e){var t=$(e.target),a=t.data("category-id"),o=CHV.obj.categories[a];t.attr("data-confirm",t.attr("data-confirm").replace("%s",'"'+PF.fn.htmlEncode(o.name)+'"'))},submit:function(e){return PF.obj.modal.form_data={action:"delete",delete:"category",deleting:{id:e}},!0},complete:{success:function(e){var t=e.responseJSON.request.deleting.id;$("[data-content=category][data-category-id="+t+"]").remove(),delete CHV.obj.categories[t],PF.fn.growl.call(PF.fn._s("The %s has been deleted.",PF.fn._s("category")))}}},add:{before:function(e){if(0!==CHV.obj.service_limits.CHEVERETO_MAX_CATEGORIES&&Object.size(CHV.obj.categories)+1>CHV.obj.service_limits.CHEVERETO_MAX_CATEGORIES)return PF.fn.growl.call("Maximum number of %t% reached (limit %s%).".replace("%t%",PF.fn._s("Categories")).replace("%s%",CHV.obj.service_limits.CHEVERETO_MAX_CATEGORIES)),!1},submit:function(){var e=PF.obj.modal.selectors.root;return!!CHV.fn.category.validateForm()&&(PF.obj.modal.form_data={action:"add-category",category:{}},$.each(CHV.fn.category.formFields,function(t,a){"id"!=a&&(PF.obj.modal.form_data.category[a]=$("[name=form-category-"+a+"]",e).val())}),!0)},complete:{success:function(e){var t=e.responseJSON.category,a="[data-content=dashboard-categories-list]",o=$("[data-content=category-dashboard-template]").html();$.each(t,function(e,t){o=o.replace(new RegExp("%"+e.toUpperCase()+"%","g"),t||"")}),$(a).append(o),0==Object.size(CHV.obj.categories)&&(CHV.obj.categories={}),CHV.obj.categories[t.id]=t,PF.fn.growl.call(PF.fn._s("Category %s added.",'"'+t.name+'"'))}}}},CHV.fn.tag={formFields:["id","name","description"],validateForm:function(e){var t=PF.obj.modal.selectors.root;return!!CHV.fn.common.validateForm(t)},edit:{before:function(e){var t=$(e.target),a=t.data("tag-id")||t.closest("[data-tag-id]").data("tag-id"),o=CHV.obj.tags[a],i="[data-modal="+t.data("target")+"]";$.each(CHV.fn.tag.formFields,function(e,t){e="form-tag-"+t,t=o[t];var a=$("[name="+e+"]",i);a.is("textarea")?a.html(PF.fn.htmlEncode(t)):a.attr("value",t)})},submit:function(){var e=PF.obj.modal.selectors.root,t=$("[name=form-tag-id]",e).val();return!!CHV.fn.tag.validateForm(t)&&(PF.obj.modal.form_data={action:"edit",edit:"tag",editing:{}},$.each(CHV.fn.category.formFields,function(t,a){PF.obj.modal.form_data.editing[a]=$("[name=form-tag-"+a+"]",e).val()}),!0)},complete:{success:function(e){var t=e.responseJSON.tag,a="[data-content=tag]",o="[data-tag-id="+t.id+"]";a+=o;$.each(t,function(e,t){$("[data-content=tag-"+e+"]",a).html(PF.fn.htmlEncode(t))}),$("[data-link=tag-url]",a).each(function(){$(this).attr("href",t.url)})}}},delete:{before:function(e){var t=$(e.target),a=t.data("tag-id")||t.closest("[data-tag-id]").data("tag-id"),o=CHV.obj.tags[a];t.attr("data-confirm",t.attr("data-confirm").replace("%s",'"'+PF.fn.htmlEncode(o.name)+'"'))},submit:function(e){return PF.obj.modal.form_data={action:"delete",delete:"tag",deleting:{id:e}},!0},complete:{success:function(e){var t=e.responseJSON.request.deleting.id;delete CHV.obj.tags[t],PF.fn.growl.call(PF.fn._s("The %s has been deleted.",PF.fn._s("tag")))}}}},CHV.fn.ip_ban={formFields:["id","ip","expires","message"],validateForm:function(e){var t=PF.obj.modal.selectors.root,a=!1,o=$("[name=form-ip_ban-ip]",t).val();return!!CHV.fn.common.validateForm(t)&&(""!==$("[name=form-ip_ban-expires]",t).val()&&0==/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test($("[name=form-ip_ban-expires]",t).val())?(PF.fn.growl.call(PF.fn._s("Invalid expiration date.")),$("[name=form-ip_ban-expires]",t).highlight(),!1):(Object.size(CHV.obj.ip_bans)>0&&$.each(CHV.obj.ip_bans,function(t,i){return void 0!==e&&i.id==e||(i.ip==o?(a=!0,!1):void 0)}),!a||(PF.fn.growl.call(PF.fn._s("IP %s already banned.",o)),$("[name=form-ip_ban-ip]",t).highlight(),!1)))},add:{submit:function(){var e=PF.obj.modal.selectors.root;return!!CHV.fn.ip_ban.validateForm()&&(PF.obj.modal.form_data={action:"add-ip_ban",ip_ban:{}},$.each(CHV.fn.ip_ban.formFields,function(t,a){"id"!=a&&(PF.obj.modal.form_data.ip_ban[a]=$("[name=form-ip_ban-"+a+"]",e).val())}),!0)},complete:{success:function(e){var t=e.responseJSON.ip_ban,a="[data-content=dashboard-ip_bans-list]",o=$("[data-content=ip_ban-dashboard-template]").html();void 0!==o&&($.each(t,function(e,t){o=o.replace(new RegExp("%"+e.toUpperCase()+"%","g"),t||"")}),$(a).append(o)),0==Object.size(CHV.obj.ip_bans)&&(CHV.obj.ip_bans={}),CHV.obj.ip_bans[t.id]=t,$("[data-content=ban_ip]").addClass("hidden"),$("[data-content=banned_ip]").removeClass("hidden"),PF.fn.growl.call(PF.fn._s("IP %s banned.",t.ip))},error:function(e){var t=e.responseJSON.error;PF.fn.growl.call(PF.fn._s(t.message))}}},edit:{before:function(e){var t=$(e.target),a=t.data("ip_ban-id"),o=CHV.obj.ip_bans[a],i="[data-modal="+t.data("target")+"]";$.each(CHV.fn.ip_ban.formFields,function(e,t){e="form-ip_ban-"+t,t=o[t];var a=$("[name="+e+"]",i);a.is("textarea")?a.html(PF.fn.htmlEncode(t)):a.attr("value",t)})},submit:function(){var e=PF.obj.modal.selectors.root,t=$("[name=form-ip_ban-id]",e).val();return!!CHV.fn.ip_ban.validateForm(t)&&(PF.obj.modal.form_data={action:"edit",edit:"ip_ban",editing:{}},$.each(CHV.fn.ip_ban.formFields,function(t,a){PF.obj.modal.form_data.editing[a]=$("[name=form-ip_ban-"+a+"]",e).val()}),!0)},complete:{success:function(e){var t=e.responseJSON.ip_ban,a="[data-content=ip_ban][data-ip_ban-id="+t.id+"]";$.each(t,function(e,t){$("[data-content=ip_ban-"+e+"]",a).html(PF.fn.htmlEncode(t))}),CHV.obj.ip_bans[t.id]=t},error:function(e){var t=e.responseJSON.error;PF.fn.growl.call(PF.fn._s(t.message))}}},delete:{before:function(e){var t=$(e.target),a=t.data("ip_ban-id"),o=CHV.obj.ip_bans[a];t.attr("data-confirm",t.attr("data-confirm").replace("%s",o.ip))},submit:function(e){return PF.obj.modal.form_data={action:"delete",delete:"ip_ban",deleting:{id:e}},!0},complete:{success:function(e){var t=e.responseJSON.request.deleting.id;$("[data-content=ip_ban][data-ip_ban-id="+t+"]").remove(),delete CHV.obj.ip_bans[t]}}}},CHV.fn.storage={formFields:["id","name","api_id","bucket","server","service","capacity","region","key","secret","url","account_id","account_name","type_chain","use_path_style_endpoint"],chain:["other","document","audio","video","image"],calling:!1,validateForm:function(e){var t=$("[name=form-storage-id]",e).val(),a=!0;if($.each($(":input",e),function(e,t){$(this).is(":hidden")?$(this).attr("required")&&$(this).removeAttr("required").attr("data-required",1):1==$(this).attr("data-required")&&$(this).attr("required","required"),$(this).is(":visible")&&""==$(this).val()&&$(this).attr("required")&&($(this).highlight(),$("label",$(this).closest(".input-label")).shake(),a=!1)}),!a)return!1;var o,i=$("[name=form-storage-capacity]",e),n=i.val();return i.is(":visible")&&""!==n&&(0==/^[\d\.]+\s*[A-Za-z]{2}$/.test(n)||void 0===n.getBytes()?o=PF.fn._s("Invalid storage capacity value. Make sure to use a valid format."):void 0!==CHV.obj.storages[t]&&n.getBytes()<CHV.obj.storages[t].space_used&&(o=PF.fn._s("Storage capacity can't be lower than its current usage (%s).",CHV.obj.storages[t].space_used.formatBytes())),o)?(PF.fn.growl.call(o),i.highlight(),!1):0!=/^https?:\/\/.+$/.test($("[name=form-storage-url]",e).val())||(PF.fn.growl.call(PF.fn._s("Invalid URL.")),$("[name=form-storage-url]",e).highlight(),!1)},toggleHttps:function(e){this.toggleBool(e,"https")},toggleActive:function(e){this.toggleBool(e,"active")},toggleBool:function(e,t){if(!this.calling){this.calling=!0;var a=$("[data-storage-id="+e+"]"),o=$("[data-content=storage-"+t+"]",a),i=$("[data-checkbox]",o),n=CHV.obj.storages[e]["is_"+t],r=0==n?1:0,s={action:"edit",edit:"storage",editing:{id:e}};s.editing["is_"+t]=r,"https"==t&&(s.editing.url=CHV.obj.storages[e].url),PF.fn.loading.fullscreen(),$.ajax({type:"POST",data:s}).always(function(e,o,n){if(CHV.fn.storage.calling=!1,PF.fn.loading.destroy("fullscreen"),void 0!==e.storage){var s=e.storage;switch(CHV.obj.storages[s.id]=s,t){case"https":$("[data-content=storage-url]",a).html(s.url)}CHV.fn.storage.toggleBoolDisplay(i,r)}else PF.fn.growl.call(e.responseJSON.error.message)})}},edit:{before:function(e){if("object"==typeof e)var t=$(e.target),a=t.data("storage-id");else a=e;var o=CHV.obj.storages[a],i="[data-combo-value~="+o.api_id+"]";$.each(CHV.fn.storage.formFields,function(e,t){e="form-storage-"+t,t=o[t];var a=$(i+" [name="+e+"]"),n=$("[name="+e+"]"),r=a.exists()?a:n;r.each(function(){if($(this).is("textarea")?$(this).html(PF.fn.htmlEncode(t)):$(this).is("input:checkbox")?($(this).prop("checked",1==t),$(this).attr("checked",1==t)):$(this).is("select")?($("option",$(this)).removeAttr("selected"),$("option",$(this)).each(function(){if($(this).attr("value")==t)return $(this).attr("selected","selected"),!1})):($(this).is("[name=form-storage-capacity]")&&void 0!==t&&t>0&&(t=String(t).formatBytes(2)),$(this).attr("value",t)),"form-storage-type_chain"===e){let e=(parseInt(t)>>>0).toString(2).paddingLeft("0".repeat(CHV.fn.storage.chain.length)).split("");CHV.fn.storage.chain.forEach(function(t,a){$("#storage_type_enable_"+t).removeAttr("checked").attr("checked",1==e[a])})}})}),$("[data-combo-value]").addClass("soft-hidden"),$(i).removeClass("soft-hidden"),CHV.fn.storage.prepareForm(o.api_id,!0)},submit:function(){var e=PF.obj.modal.selectors.root;$("[name=form-storage-id]",e).val();if(!CHV.fn.storage.validateForm(PF.obj.modal.selectors.root))return!1;PF.obj.modal.form_data={action:"edit",edit:"storage",editing:{}},$.each(CHV.fn.storage.formFields,function(t,a){let o,i;o="[name=form-storage-"+a+"]","hidden"!==$(o,e).attr("type")&&(o+=":visible"),i=$(o,e).val(),$(o,e).is("input:checkbox")&&(i=$(o,e).prop("checked")?"1":"0"),PF.obj.modal.form_data.editing[a]=i});let t=CHV.fn.storage.chain.map(function(t){return $("#storage_type_enable_"+t,e).prop("checked")?1:0});return PF.obj.modal.form_data.editing.type_chain=parseInt(t.join(""),2),!0},complete:{success:function(e){var t=e.responseJSON.storage,a="[data-content=storage][data-storage-id="+t.id+"]",o=$("[data-action=toggle-storage-https]",a);$.each(t,function(e,t){$("[data-content=storage-"+e+"]",a).html(PF.fn.htmlEncode(t))}),CHV.obj.storages[t.id]=t,CHV.fn.storage.toggleBoolDisplay(o,1==t.is_https)},error:function(e){var t=e.responseJSON,a=t.error.message;PF.fn.growl.call({message:a,insertTo:"#fullscreen-modal-box #growl-placeholder"})}}},add:{before:function(e){if(0!==CHV.obj.service_limits.CHEVERETO_MAX_STORAGES&&Object.size(CHV.obj.storages)+1>CHV.obj.service_limits.CHEVERETO_MAX_STORAGES)return PF.fn.growl.call("Maximum number of %t% reached (limit %s%).".replace("%t%",PF.fn._s("External storage")).replace("%s%",CHV.obj.service_limits.CHEVERETO_MAX_STORAGES)),!1;var t=$("select[name=form-storage-api_id]").prop("value");$.each(CHV.fn.storage.formFields,function(e,t){if("api_id"!==t){e="form-storage-"+t;var a=$("[name="+e+"]");a.each(function(){if($(this).is(":checkbox")){let e=$(this).is('[data-checked="1"]');e?$(this).attr("checked","checked"):$(this).removeAttr("checked"),$(this).prop("checked",e)}else $(this).val("").prop("value","").attr("value","")})}}),CHV.fn.storage.prepareForm(t,!0)},submit:function(){if(!CHV.fn.storage.validateForm(PF.obj.modal.selectors.root))return!1;var e=PF.obj.modal.selectors.root;PF.obj.modal.form_data={action:"add-storage",storage:{}},$.each(CHV.fn.storage.formFields,function(t,a){let o,i;o="[name=form-storage-"+a+"]","hidden"!==$(o,e).attr("type")&&(o+=":visible"),i=$(o,e).val(),$(o,e).is("input:checkbox")&&(i=$(o,e).prop("checked")?"1":"0"),PF.obj.modal.form_data.storage[a]=i});let t=CHV.fn.storage.chain.map(function(t){return $("#storage_type_enable_"+t,e).prop("checked")?1:0});return PF.obj.modal.form_data.storage.type_chain=parseInt(t.join(""),2),!0},complete:{success:function(e){var t=e.responseJSON.storage,a="[data-content=dashboard-storages-list]",o=$("[data-content=storage-dashboard-template]").html();$.each(t,function(e,t){var a=e.toUpperCase();if("is_https"==e||"is_active"==e)t=CHV.obj.storageTemplate.icon.replace("%TITLE%",CHV.obj.storageTemplate.messages[e]).replace("%ICON%",CHV.obj.storageTemplate.checkboxes[t]).replace("%PROP%",e.replace("is_",""));o=o.replace(new RegExp("%"+a+"%","g"),t||"")}),$(a).append(o),PF.fn.bindtipTip($("[data-storage-id="+t.id+"]")),0==CHV.obj.storages.length&&(CHV.obj.storages={}),CHV.obj.storages[t.id]=t},error:function(e){var t=e.responseJSON,a=t.error.message;PF.fn.growl.call({message:a,insertTo:"#fullscreen-modal-box #growl-placeholder"})}}},delete:{before:function(e){var t=$(e.target),a=t.data("storage-id"),o=CHV.obj.storages[a];t.attr("data-confirm",t.attr("data-confirm").replace("%s",'"'+o.name+'" (ID '+o.id+")"))},submit:function(e){return PF.obj.modal.form_data={action:"delete",delete:"storage",deleting:{id:e}},!0},complete:{success:function(e){var t=e.responseJSON.request.deleting.id;$("[data-content=storage][data-storage-id="+t+"]").remove(),delete CHV.obj.storages[t]},error:function(e){PF.fn.growl.call(e.responseJSON.error.message)}}},toggleBoolDisplay:function(e,t){var a={0:e.data("unchecked-icon"),1:e.data("checked-icon")};e.removeClass(a[0]+" "+a[1]).addClass(a[t?1:0])},prepareForm:function(e,t){var a="[data-combo-value~="+e+"]";t=void 0!==t&&t;$(":input","[data-combo-value]:hidden").each(function(){$(this).attr("disabled")&&!$(this).is("[data-hide-disabled]")||($(this).prop("disabled",!0),$(this).attr("data-hide-disabled",1))}),$(":input",a).each(function(){$(this).is("[data-hide-disabled]")&&($(this).prop("disabled",!1),$(this).removeAttr("data-hide-disabled"))}),t&&setTimeout(function(){$("#form-storage-api_id").trigger("change")},1)}},CHV.fn.common={validateForm:function(e){if(void 0===e)e=PF.obj.modal.selectors.root;var t=!0;return $.each($(":input:visible",e),function(e,a){""==$(this).val()&&$(this).attr("required")&&($(this).highlight(),t=!1)}),!!t},updateDoctitle:function(e){void 0!==CHV.obj.page_info&&(CHV.obj.page_info.pre_doctitle=e,CHV.obj.page_info.doctitle=CHV.obj.page_info.pre_doctitle+CHV.obj.page_info.pos_doctitle,document.title=CHV.obj.page_info.doctitle)}},CHV.fn.user={add:{before:function(){if(0!==CHV.obj.service_limits.CHEVERETO_MAX_USERS&&CHV.obj.stat_totals.users+1>CHV.obj.service_limits.CHEVERETO_MAX_USERS)return PF.fn.growl.call("Maximum number of %t% reached (limit %s%).".replace("%t%",PF.fn._s("Users")).replace("%s%",CHV.obj.service_limits.CHEVERETO_MAX_USERS)),!1},submit:function(){var e=$(PF.obj.modal.selectors.root),t=!0;return $.each($(":input",e),function(e,a){""==$(this).val()&&$(this).attr("required")&&($(this).highlight(),t=!1)}),!!t&&(PF.obj.modal.form_data={action:"add-user",user:{username:$("[name=form-username]",e).val(),email:$("[name=form-email]",e).val(),password:$("[name=form-password]",e).val(),role:$("[name=form-role]",e).val()}},!0)},complete:{success:function(e){e.responseJSON},error:function(e){var t=e.responseJSON;PF.fn.growl.call(PF.fn._s(t.error.message))}}},delete:{submit:function(){return PF.obj.modal.form_data={action:"delete",delete:"user",owner:CHV.obj.resource.user.id,deleting:CHV.obj.resource.user},!0}},ban:{submit:function(){return PF.obj.modal.form_data={action:"ban",ban:"user",banning:CHV.obj.resource.user.id},!0},success:function(){}}},CHV.fn.submit_resource_approve=function(){return PF.obj.modal.form_data={action:"approve",approve:CHV.obj.resource.type,from:"resource",owner:void 0!==CHV.obj.resource.user?CHV.obj.resource.user.id:null,approving:CHV.obj.resource},!0},CHV.fn.complete_resource_approve={success:function(e){$("body").fadeOut("normal",function(){document.location.replace(CHV.obj.resource.url.addURLParameterNoCache())})}},CHV.fn.submit_resource_delete=function(){return PF.obj.modal.form_data={action:"delete",delete:CHV.obj.resource.type,from:"resource",owner:void 0!==CHV.obj.resource.user?CHV.obj.resource.user.id:null,deleting:CHV.obj.resource},!0},CHV.fn.complete_resource_delete={success:function(e){$("body").fadeOut("normal",function(){document.location.replace(CHV.obj.resource.url.addURLParameterNoCache())})}},CHV.fn.list_editor={blink:function(e){e.addClass("ui-selecting"),setTimeout(function(){e.removeClass("ui-selecting")},200)},selectionCount:function(){var e=$(PF.obj.listing.selectors.content_listing);e.each(function(){var t=$(PF.obj.listing.selectors.list_item,this).length,a=$(this).attr("id"),o=$("[data-content=list-selection][data-tab="+a+"]"),i=$("[data-content=pop-selection]",o),n=$(PF.obj.listing.selectors.list_item+".selected",this).length;if(o.attr("data-selected-count",n),i.toggleClass("disabled",0===t||0===n),$("[data-text=selection-count]",i).text(n>0?n:""),"images"==e.data("list")&&n>0){var r=$(PF.obj.listing.selectors.list_item+".selected[data-flag=safe]",this).length>0,s=$(PF.obj.listing.selectors.list_item+".selected[data-flag=unsafe]",this).length>0;$("[data-action=flag-safe]",i).parent()[(s?"remove":"add")+"Class"]("hidden"),$("[data-action=flag-unsafe]",i).parent()[(r?"remove":"add")+"Class"]("hidden")}$(this).is(":visible")&&($("body").toggleClass("--has-selection",n>0),CHV.fn.list_editor.listMassActionSet(t==n?"clear":"select"))})},removeFromList:function(e,t){if(void 0!==e){e=e instanceof jQuery==0?$(e):e;var a=$(PF.obj.listing.selectors.content_listing_visible),o=e.length;e.fadeOut("fast");var i=e.first().data("type"),n=parseInt($("[data-text="+i+"-count]").text())-o;CHV.fn.list_editor.updateUserCounters(e.first().data("type"),o,"-"),e.promise().done(function(){$(document).removeClass(CHV.fn.listingViewer.selectors.bodyShown.substr(1));var i={};if(e.each(function(){$("[data-id="+$(this).data("id")+"]").each(function(){var e=$(this).closest(PF.obj.listing.selectors.content_listing).attr("id");i[e]||(i[e]=0),i[e]+=1})}),1==o?$("[data-id="+$(this).data("id")+"]").remove():e.each(function(){$("[data-id="+$(this).data("id")+"]").remove()}),PF.fn.listing.columnizerQueue(),PF.fn.listing.refresh(),CHV.fn.list_editor.selectionCount(),void 0!==t&&"string"==typeof t&&PF.fn.growl.call(t),$(PF.obj.listing.selectors.content_listing_pagination,a).exists()||0!=$(PF.obj.listing.selectors.list_item,a).length||(n=0),0==n)a.html(PF.obj.listing.template.empty),$(PF.obj.listing.selectors.content_listing+":not("+PF.obj.listing.selectors.content_listing_visible+")").data({empty:null,load:"ajax"}),$("[data-content=list-selection][data-tab="+a.attr("id")+"]").addClass("disabled");else if(0==$(PF.obj.listing.selectors.list_item,a).length){if($(PF.obj.listing.selectors.pad_content).height(0),$("[data-action=load-more]",a).exists())return $(PF.obj.listing.selectors.content_listing_visible).data("page",0),$("[data-action=load-more]",a).trigger("click"),void(PF.obj.listing.recolumnize=!0);var r=$("[data-pagination=next]",a);if(r.exists()){var s=r.attr("href"),l=PF.fn.deparam(s);return"page"in l&&l.page>1&&(s=s.changeURLParameterValue("page",l.page-1)),void(window.location=s)}}})}},deleteFromList:function(e){if(void 0===t)var t=!0;e=e instanceof jQuery==0?$(e):e;this.removeFromList(e)},moveFromList:function(e,t){if(void 0===t)t=!0;e=e instanceof jQuery==0?$(e):e;this.removeFromList(e)},toggleSelectItem:function(e,t){if("boolean"!=typeof t)t=!e.hasClass("selected");var a,o,i,n=$(".viewer").is(":visible")?$("[data-type=image][data-id="+e.attr("data-id")+"]"):e,r=$("[data-action=select] .btn-icon",n);n.hasClass("unselect")||(n.addClass("unselect"),t?(Boolean(window.navigator.vibrate)&&window.navigator.vibrate([15,125,25]),n.addClass("selected"),a=r.data("icon-selected"),o=r.data("icon-unselected"),i=PF.fn._s("Unselect")):(n.removeClass("selected ui-selected"),a=r.data("icon-unselected"),o=r.data("icon-selected"),i=PF.fn._s("Select")),r.removeClass(o).addClass(a),n.removeClass("unselect"),$("[data-action=select] .label",n).text(i),CHV.fn.list_editor.selectionCount())},selectItem:function(e){this.toggleSelectItem(e,!0)},unselectItem:function(e){this.toggleSelectItem(e,!1)},selectAll:function(e){var t=$(PF.obj.listing.selectors.list_item+":visible:not(.selected)");this.selectItem(t),this.listMassActionSet("clear"),e.stopPropagation()},clearSelected:function(){var e=$(PF.obj.listing.selectors.list_item+".selected",PF.obj.listing.selectors.content_listing_visible);this.unselectItem(e),this.listMassActionSet("select")},listMassActionSet:function(e){var t="select"==e?"clear":"select",a=$("[data-text-select-all][data-action=list-"+t+"-all]:visible"),o=a.data("text-"+e+"-all");a.text(o).attr("data-action","list-"+e+"-all")},updateItem:function(e,t,a,o){var i;if(console.log("que mierda"),e instanceof jQuery==0)e=$(e);var n=e.data("type"),r="image"==n?t.album:t;if(this.addAlbumtoModals(r),$('option[value="'+r.id_encoded+'"]',"[name=form-album-id]").html(PF.fn.htmlEncode(r.name_with_privacy_readable_html)),void 0===a)a="edit";if("edit"==a||"move"==a){if("move"==a&&"album"==CHV.obj.resource.type)return console.log("Moving from album",e,o),void CHV.fn.list_editor.moveFromList(e,o);e.attr("data-description",t.description),
"image"==n?(void 0!==t.title&&(e.attr("data-title",t.title),e.find("[title]").attr("title",t.title),$("[data-text=image-title]",e).text(PF.fn.htmlEncode(t.title))),void 0!==t.title_truncated&&$("[data-text=image-title-truncated]",e).html(PF.fn.htmlEncode(t.title_truncated)),void 0!==t.category_id&&e.attr("data-category-id",t.category_id),e.attr({"data-tags":t.tags_string,"data-album-id":r.id_encoded,"data-flag":1==t.nsfw?"unsafe":"safe"}),$("[data-content=album-link]",e).attr("href",r.url)):(i=PF.fn.htmlEncode(r.name),e.attr({"data-description":r.description,"data-password":r.password,"data-name":i})),e.attr("data-privacy",r.privacy),$("[data-text=album-name]",e).html(i)}},addAlbumtoModals:function(e){var t=!1;$("[name=form-album-id]","[data-modal]").each(function(){e.id_encoded&&!$('option[value="'+e.id_encoded+'"]',this).exists()&&($(this).append('<option value="'+e.id_encoded+'">'+e.name_with_privacy_readable_html+"</option>"),t=!0)}),t&&CHV.fn.list_editor.updateUserCounters("album",1,"+")},updateAlbum:function(e){$("[data-id="+e.id_encoded+"]").each(function(){""!==e.html&&($(this).after(e.html),$(this).remove())})},updateUserCounters:function(e,t,a){if(void 0===a)a="+";var o,i,n=$("[data-text="+e+"-count]"),r=$("[data-text="+e+"-label]"),s=(t=parseInt(t),parseInt(n.html()));switch(a){case"+":o=s+t;break;case"-":o=s-t;break;case"=":o=t}i=o-s;var l=$("[data-text=total-"+n.data("text")+"]"),d=$("[data-text="+l.data("text")+"-label]"),c=parseInt(l.html()),u=c+i;n.text(o),l.text(u),r.text(r.data(1==o?"label-single":"label-plural")),d.text(r.data(1==u?"label-single":"label-plural"))},updateMoveItemLists:function(e,t,a){if(CHV.fn.list_editor.clearSelected(),/image/.test(t))"image"==t?CHV.fn.list_editor.updateItem("[data-type=image][data-id="+a.data("id")+"]",e.image,"move"):a.each(function(){CHV.fn.list_editor.updateItem("[data-type=image][data-id="+$(this).data("id")+"]",e,"move",!1)});else{if(CHV.fn.list_editor.moveFromList(a,!1),e.album)if(void 0!==e.albums_old?"true"==e.request.album.new:"true"==e.request.editing.new_album){CHV.fn.list_editor.addAlbumtoModals(e.album);var o=parseInt($("[data-text=album-count]").text())-1;$(PF.obj.listing.selectors.pad_content).each(function(){var t=$(this).find(PF.obj.listing.selectors.list_item).length;if(0!=t){var a=PF.fn.parseQueryString($(this).closest(PF.obj.listing.selectors.content_listing).data("params"));"date_desc"!=a.sort&&o!=t||$(this)["date_desc"==a.sort?"prepend":"append"](e.album.html)}})}else CHV.fn.list_editor.updateAlbum(e.album);PF.fn.listing.columnizerQueue(),PF.fn.listing.refresh(0)}}},CHV.fn.import={errorHandler:function(e){PF.fn.growl.call(e.error.message)},reset:function(e){e=parseInt(e);CHV.obj.import.working[e].stats=$.ajax({type:"POST",data:{action:"importReset",id:e}}),CHV.obj.import.working[e].stats.complete(function(t){var a=t.responseJSON;if(a){var o=CHV.fn.import.parseTemplate(a.import);$("[data-id="+a.import.id+"]",CHV.obj.import.sel.root).replaceWith(o),"working"!=a.import.status&&clearInterval(CHV.obj.import.working[e].interval)}})},updateStats:function(e){e=parseInt(e);"readyState"in CHV.obj.import.working[e].stats&&4!=CHV.obj.import.working[e].stats.readyState?console.error("Aborting stats timeout call (previous call is still not ready)"):(CHV.obj.import.working[e].stats=$.ajax({type:"POST",data:{action:"importStats",id:e}}),CHV.obj.import.working[e].stats.complete(function(t){var a=t.responseJSON;if(a){var o=CHV.fn.import.parseTemplate(a.import);$("[data-id="+a.import.id+"]",CHV.obj.import.sel.root).replaceWith(o),"working"!=a.import.status&&clearInterval(CHV.obj.import.working[e].interval)}}))},delete:{submit:function(e){return PF.obj.modal.form_data={action:"importDelete",id:e},!0},deferred:{success:function(e){var t=e.responseJSON;PF.fn.growl.call(PF.fn._s("Import ID %s removed",t.import.id)),$("[data-id="+t.import.id+"]",CHV.obj.import.sel.root).remove(),1==$("li",CHV.obj.import.sel.root).size()&&$(CHV.obj.import.sel.root).addClass("hidden")},error:function(e){CHV.fn.import.errorHandler(e.responseJSON)}}},parseTemplate:function(e,t){var a=CHV.obj.import.rowTpl;for(var o in CHV.obj.import.importTr)void 0!==e[o]&&(a=a.replaceAll("%"+o+"%",e[o]));a=a.replaceAll("%parse%",e.options.root),a=a.replaceAll("%shortParse%",e.options.root.charAt(0)),a=a.replaceAll("%displayStatus%",CHV.obj.import.statusesDisplay[e.status]);var i=$($.parseHTML(a)).attr("data-object",JSON.stringify(e));return i}},CHV.fn.Palettes={timeout:{},get:function(){return($("html").get(0).className.match(/(^|\s)palette-\S+/g)||[]).join(" ")},set:function(e){$("html").attr("data-palette",e).removeClass(this.get()).addClass("palette-"+e)},preview:function(e){$("html").removeClass(this.get()).addClass("palette-"+e)},save:function(){clearTimeout(this.timeout),this.timeout=setTimeout(function(){$.ajax({type:"POST",data:{action:"paletteSet",palette_id:CHV.obj.config.palettesId[$("html").attr("data-palette")]},cache:!1})},400)}},CHV.fn.license={set:{submit:function(){var e=$(PF.obj.modal.selectors.root),t=!0;return $.each($(":input",e),function(e,a){""==$(this).val()&&$(this).attr("required")&&($(this).highlight(),t=!1)}),!!t&&(PF.obj.modal.form_data={action:"set-license-key",key:$("[name=chevereto-license-key]",e).val()},!0)},complete:{success:function(e){let t=e.responseJSON,a=$("[data-action=upgrade]");if("free"===CHV.obj.system_info.edition)return a.removeClass("hidden"),void a.trigger("click");PF.fn.growl.call(PF.fn._s(t.success.message))},error:function(e){var t=e.responseJSON;PF.fn.growl.call(PF.fn._s(t.error.message))}}}},CHV.fn.user_background={delete:{submit:function(){return PF.obj.modal.form_data={action:"delete",delete:"background",owner:CHV.obj.resource.user.id},!0},deferred:{success:{before:function(e){$("[data-content=user-background-cover-src]").css("background-image","none"),$("[data-content=user-background-cover], .top-user").addClass("no-background"),$("[data-content=user-background-cover]").height(""),$("[data-content=user-upload-background]").removeClass("hidden").show(),$("[data-content=user-change-background]").hide()},done:function(e){PF.fn.modal.close()}},error:function(e){PF.fn.growl.call(PF.fn._s("Error deleting profile background image."))}}}},CHV.fn.user_api={delete:{submit:function(){return PF.obj.modal.form_data={action:"delete",delete:"api_key",owner:CHV.obj.resource.user.id},!0},deferred:{success:{before:function(e){},done:function(e){PF.fn.modal.close(function(){location.reload()})}},error:function(e){PF.fn.growl.call(e.responseJSON.error.message)}}}},CHV.fn.user_two_factor={delete:{submit:function(){return PF.obj.modal.form_data={action:"delete",delete:"two_factor",owner:CHV.obj.resource.user.id},!0},deferred:{success:{before:function(e){},done:function(e){PF.fn.modal.close(function(){location.reload()})}},error:function(e){PF.fn.growl.call(e.responseJSON.error.message)}}}},CHV.str.mainform="[data-content=main-form]",CHV.obj.timezone={selector:"[data-content=timezone]",input:"#timezone-region"},$(function(){function e(e){e=e.originalEvent;var t=!1;if(e.dataTransfer.types)for(var a=0;a<e.dataTransfer.types.length;a++)if("Files"==e.dataTransfer.types[a]){t=!0;break}return t}function t(){if(!PF.fn.isDevice(["phone","phablet"])){var e,t,a=$(".top-bar-notifications-list ul",".top-bar:visible");a.css("height",""),e=a.height(),a.data("height",e).css("height","auto"),t=a.height(),t>e&&(a.height(e),a.closest(".antiscroll-wrap").antiscroll())}}function a(e){e.addClass("list-item-play-gif--loading");var t=e.closest(PF.obj.listing.selectors.list_item),a=$(".image-container",t),o=$("img",a),i=o.attr("src"),n=".md",r=i.lastIndexOf(n);if(-1==r)n=".th",r=i.lastIndexOf(n);var s=i.substr(0,r)+i.substr(r+n.length,i.length);a.append(a.html()),$load=t.find(".image-container img").eq(1).attr("src",s).addClass("hidden"),$load.imagesLoaded(function(){e.remove(),o.remove(),$("img",a).show(),$(this.elements).removeClass("hidden")})}function o(e,t){var a=$(e).closest(PF.obj.listing.selectors.list_item);CHV.fn.list_editor.blink(a),CHV.fn.list_editor.toggleSelectItem(a),PF.fn.keyFeedback.spawn(t),t.preventDefault(),t.stopPropagation()}function i(e,t,a){var o=$('input[data-target="#'+a.attr("id")+'"]'),i=o.val().split(",").map(e=>e.trim());a.empty(),$.each(e,function(e,o){if(!i.includes(o)){var n=t.replace(/%name%/g,PF.fn.htmlEncode(o));a.append($(n))}})}var n;if($(window).resize(function(e){clearTimeout(n),n=setTimeout(function(){CHV.fn.uploader.boxSizer(),CHV.fn.bindSelectableItems(),CHV.fn.listingViewer.placeholderSizing(),prevWidth=$(window).width(),prevHeight=$(window).height()},10)}),window.opener&&($(window).on("load",function(e){window.opener.postMessage({id:window.name,requestAction:"postSettings"},"*"),CHV.obj.opener.uploadPlugin[window.name]={autoInsert:!1,autoClose:!1}}),$(window).on("message",function(e){var t=e.originalEvent.data,a=void 0===t.type?"upload-plugin":t.type;if("upload-plugin"===a){if(void 0===t.id||void 0===t.settings)return;if(window.name!==t.id)return;"autoInsert"in t.settings&&(t.settings.autoInsert&&"0"!=t.settings.autoInsert||(t.settings.autoInsert=!1)),"autoClose"in t.settings&&(t.settings.autoClose=t.settings.autoClose&&"0"!=t.settings.autoClose),CHV.obj.opener.uploadPlugin[t.id]={...CHV.obj.opener.uploadPlugin[t.id],...t.settings}}})),$("#home-cover, #maintenance-wrapper, #login").exists()){var r=$("#maintenance-wrapper").exists()?$("#maintenance-wrapper").css("background-image").slice(4,-1).replace(/^\"|\"$/g,""):$(".home-cover-img","#home-cover-slideshow").first().attr("data-src");function s(){$("body").addClass("load"),$("#maintenance-wrapper").exists()||$(".home-cover-img","#home-cover-slideshow").first().css("background-image","url("+r+")").addClass("animate-in--alt").removeAttr("data-src"),setTimeout(function(){setTimeout(function(){$("body").addClass("loaded")},1200),setTimeout(function(){d()},7e3)},600)}var l=function(){setTimeout(function(){d()},8e3)};function d(){var e=$(".home-cover-img[data-src]","#home-cover-slideshow").first(),t=$(".home-cover-img","#home-cover-slideshow");if(0==e.length){if(1==t.length)return;t.first().removeClass("animate-in"),$("#home-cover-slideshow").append(t.first()),setTimeout(function(){$(".home-cover-img:last","#home-cover-slideshow").addClass("animate-in")},20),setTimeout(function(){$(".home-cover-img:not(:last)","#home-cover-slideshow").removeClass("animate-in")},4e3),l()}else{var a=e.attr("data-src");$("<img/>").attr("src",a).on("load error",function(){$(this).remove(),e.css("background-image","url("+a+")").addClass("animate-in").removeAttr("data-src"),setTimeout(function(){$(".home-cover-img:not(:last)","#home-cover-slideshow").removeClass("animate-end animate-in--alt")},2e3),l()})}}r?$("<img/>").attr("src",r).on("load error",function(){$(this).remove(),s()}):s()}var c,u=CHV.fn.uploader.selectors.root,m=CHV.fn.uploader.selectors.queue,f=$(u),p=$(m);$(document).on("click","[data-action=top-bar-upload]",function(e){$("body").is("#upload")||"js"!==$(this).data("link")||CHV.fn.uploader.toggle({reset:!1}),"page"!==$(this).data("link")&&(e.preventDefault(),e.stopPropagation())}),$(document).on("click mouseover mouseout","[data-action=palette]",function(e){clearTimeout(c),e.preventDefault();var t=$(this).data("palette");switch(e.type){case"mouseover":c=setTimeout(function(){CHV.fn.Palettes.preview(t)},1e3);break;case"mouseout":t=$("html").attr("data-palette")||"",CHV.fn.Palettes.set(t);break;case"click":e.stopPropagation(),$("[data-action=palette]","[data-content=palettes]").removeClass("current"),$(this).addClass("current"),CHV.fn.Palettes.set(t),CHV.fn.Palettes.save()}}),$(document).on("change","#palettes",function(e){CHV.fn.Palettes.set(this.value),CHV.fn.Palettes.save()}),$("[data-action=close-upload]",f).click(function(){f.is(":animated")||$("[data-action=top-bar-upload]","#top-bar").trigger("click")}),$("[data-action=reset-upload]",f).click(function(){CHV.fn.uploader.isUploading&&$("[data-action=cancel-upload-remaining], [data-action=cancel-upload]",f).trigger("click"),CHV.fn.uploader.reset()}),$("[data-action=cancel-upload-remaining], [data-action=cancel-upload]",f).click(function(){CHV.fn.uploader.isUploading=!1,$("[data-action=cancel]",p).click(),Object.size(CHV.fn.uploader.results.success)>0?CHV.fn.uploader.displayResults():CHV.fn.uploader.reset()}),$(document).on("click","[data-action=upload-privacy]:not(disabled)",function(e){e.isDefaultPrevented()||(current_privacy=$(this).data("privacy"),target_privacy="public"==current_privacy?"private":"public",this_lock=$(".icon",this).data("lock"),this_unlock=$(".icon",this).data("unlock"),$(".icon",this).removeClass(this_lock+" "+this_unlock).addClass("public"==current_privacy?this_lock:this_unlock),$(this).data("privacy",target_privacy),$("[data-action=upload-privacy-copy]").html($("[data-action=upload-privacy]").html()),$upload_button=$("[data-action=upload]",f),$upload_button.text($upload_button.data(target_privacy)),$(this).tipTip("hide"))}),$(CHV.fn.uploader.selectors.file+", "+CHV.fn.uploader.selectors.camera).on("change",function(e){$(CHV.fn.uploader.selectors.root).data("shown")?CHV.fn.uploader.add(e):CHV.fn.uploader.toggle({callback:function(e){CHV.fn.uploader.add(e)}},e)}).on("click",function(e){!$(this).data("login-needed")||PF.fn.is_user_logged()}),$(CHV.fn.uploader.selectors.root).exists()&&($("body").on({dragenter:function(t){if(t.preventDefault(),!e(t))return!1;$(CHV.fn.uploader.selectors.dropzone).exists()||$("body").append($('<div id="'+CHV.fn.uploader.selectors.dropzone.replace("#","")+'"/>').css({width:"100%",height:"100%",position:"fixed",zIndex:1e3,left:0,top:0}))}}),$(document).on({dragover:function(t){if(t.preventDefault(),!e(t))return!1;$(CHV.fn.uploader.selectors.root).data("shown")||CHV.fn.uploader.toggle({reset:!1})},dragleave:function(e){$(CHV.fn.uploader.selectors.dropzone).remove(),$.isEmptyObject(CHV.fn.uploader.files)&&CHV.fn.uploader.toggle()},drop:function(e){e.preventDefault(),CHV.fn.uploader.add(e),$(CHV.fn.uploader.selectors.dropzone).remove()}},CHV.fn.uploader.selectors.dropzone)),$(document).on("keyup change","[data-action=resize-combo-input]",function(e){var t=$(this).closest("[data-action=resize-combo-input]"),a=$("[name=form-width]",t),o=$("[name=form-height]",t),i=a.data("initial")/o.data("initial"),n={width:Math.round(a.prop("value")/i),height:Math.round(o.prop("value")*i)};$(e.target).is(a)?o.prop("value",Math.round(n.width)):a.prop("value",Math.round(n.height))}),$(document).on("click",m+" [data-action=edit]",function(){for(var e=$(this).closest("li"),t=e.data("id"),a=CHV.fn.uploader.files[t],o=a.type.substring(0,a.type.indexOf("/")),i=PF.obj.modal.selectors.root,n=$.extend({},a.formValues||a.parsedMeta),r=["album_id","category_id","nsfw"],s=0;s<r.length;s++){var l=r[s];if(void 0===n[l]){var d=$("[name=upload-"+l.replace("_","-")+"]",CHV.fn.uploader.selectors.root),c=d.prop(d.is(":checkbox")?"checked":"value");n[l]=d.is(":checkbox")?c?"1":null:c}}PF.fn.modal.call({type:"html",template:$("#anywhere-upload-edit-item").html(),callback:function(){$("[data-content=icon]",i).addClass("fa-file-"+o);var e={width:0!=CHV.obj.config.image.max_width?CHV.obj.config.image.max_width:n.width,height:0!=CHV.obj.config.image.max_height?CHV.obj.config.image.max_height:n.height},r=$.extend({},e),s=n.width/n.height;r.width=Math.round(e.height*s),r.height=Math.round(e.width/s),r.height>e.height&&(r.height=e.height,r.width=Math.round(r.height*s)),r.width>e.width&&(r.width=e.width,r.height=Math.round(r.width/s)),$.each(n,function(e,t){var n="[name=form-"+e.replace(/_/g,"-")+"]",s=$(n,i);if(!s.exists())return!0;if(s.is(":checkbox"))s.prop("checked",s.attr("value")==t);else if(s.is("select")){var l=s.find('[value="'+t+'"]');l.exists()||(l=s.find("option:first")),l.prop("selected",!0)}else s.prop("value",t);if("width"==e||"height"==e){var d=r[e],c=a.parsedMeta[e]>d?d:a.parsedMeta[e];s.prop("max",c).data("initial",a.parsedMeta[e]).prop("value",c),"image"!==o&&s.prop("disabled",!0).closest("[data-action=resize-combo-input]").hide()}}),"image/gif"!==a.parsedMeta.mimetype&&$("[ data-content=animated-gif-warning]",i).remove(),$(".image-preview",i).append($("<canvas/>",{class:"canvas checkered-background"}));var l=$(".queue-item[data-id="+t+"] .preview .canvas")[0],d=$(".image-preview .canvas",i)[0];d.width=l.width,d.height=l.height;var c=d.getContext("2d");c.drawImage(l,0,0)},confirm:function(){if(PF.fn.form_modal_has_changed()){var e=!1;return $.each(["width","height"],function(t,a){var o=$("[name=form-"+a+"]",i),n=parseInt(o.val()),r=parseInt(o.attr("min")),s=parseInt(o.attr("max"));if(n>s||n<r)return o.highlight(),e=!0,!0}),e?!1:(void 0===a.formValues&&(a.formValues={title:null,tags:null,category_id:null,width:null,height:null,nsfw:null,expiration:null,description:null,album_id:null}),$(":input[name]",i).each(function(e,t){var o=$(this).attr("name").replace("form-","").replace(/-/g,"_");if(void 0===a.formValues[o])return!0;a.formValues[o]=$(this).is(":checkbox")?$(this).is(":checked")?$(this).prop("value"):null:$(this).prop("value")}),CHV.fn.uploader.files[t].formValues=a.formValues,!0)}PF.fn.modal.close()}})}),$(document).on("click",m+" [data-action=cancel]",function(){var e=$(this).closest("li"),t=e.closest("ul"),a=e.data("id"),o=t.height(),i=!1;if(!e.hasClass("completed")&&!e.hasClass("failed")){if($("#tiptip_holder").hide(),e.tipTip("destroy").remove(),o!==t.height()&&CHV.fn.uploader.boxSizer(),$("li",p).exists()||$("[data-group=upload-queue-ready], [data-group=upload-queue], [data-group=upload-queue-ready]",f).css("display",""),CHV.fn.uploader.files[a]&&void 0!==CHV.fn.uploader.files[a].xhr&&(CHV.fn.uploader.files[a].xhr.abort(),i=!0),void 0!==CHV.fn.uploader.files[a]&&void 0!==CHV.fn.uploader.files[a].fromClipboard){var n=CHV.fn.uploader.files[a].md5,r=CHV.fn.uploader.clipboardImages.indexOf(n);r>-1&&CHV.fn.uploader.clipboardImages.splice(r,1)}delete CHV.fn.uploader.files[a],CHV.fn.uploader.queueSize(),0==Object.size(CHV.fn.uploader.files)?"success"in CHV.fn.uploader&&"results"in CHV.fn.uploader&&(0!=Object.size(CHV.fn.uploader.results.success)||0!=Object.size(CHV.fn.uploader.results.error))||CHV.fn.uploader.reset():i&&0!==$("li.waiting",t).first().length&&CHV.fn.uploader.upload($("li.waiting",t).first())}}),$(document).on("click","[data-action=upload]",function(){if(void 0===CHV.obj.logged_user&&!1===$("#upload-tos").prop("checked"))return $("#upload-tos").prop("required",!0)[0].reportValidity(),!1;$("[data-group=upload], [data-group=upload-queue-ready]",f).hide(),f.removeClass("queueReady").addClass("queueUploading").find("[data-group=uploading]").show(),CHV.fn.uploader.queueSize(),CHV.fn.uploader.canAdd=!1,$queue_items=$("li",p),$queue_items.addClass("uploading waiting"),CHV.fn.uploader.timestamp=(new Date).getTime(),CHV.fn.uploader.upload($queue_items.first("li"))}),$("#top-bar-shade").exists()&&$("#top-bar-shade").css("opacity")&&$("#top-bar-shade").data("initial-opacity",Number($("#top-bar-shade").css("opacity"))),CHV.fn.bindSelectableItems(),$("body#image").exists()&&($(CHV.obj.image_viewer.selector+" [data-load=full]").length>0&&($(document).on("click",CHV.obj.image_viewer.loader,function(e){CHV.fn.viewerLoadImage()}),$(CHV.obj.image_viewer.loader).data("size")>CHV.obj.config.image.load_max_filesize.getBytes()?$(CHV.obj.image_viewer.loader).css("display","block"):CHV.fn.viewerLoadImage()),new MutationObserver(()=>{$("html").height()>$(window).innerHeight()&&!$("html").hasClass("scrollbar-y")&&($("html").addClass("scrollbar-y"),$(document).data({width:$(this).width(),height:$(this).height()}))}).observe(document,{childList:!0}),$(document).on("keyup",function(e){var t=$(e.target),a=e.originalEvent;if(!t.is(":input")&&CHV.obj.image_viewer.$navigation.exists()&&("ArrowLeft"==a.key||"ArrowRight"==a.key)){var o=$("[data-action="+("ArrowLeft"==a.key?"prev":"next")+"]",CHV.obj.image_viewer.$navigation).attr("href");void 0!==o&&""!==o&&(window.location=$("[data-action="+("ArrowLeft"==a.key?"prev":"next")+"]",CHV.obj.image_viewer.$navigation).attr("href"))}})),$(document).on("click",CHV.obj.image_viewer.container+" img",function(e){$(CHV.obj.image_viewer.loader).exists()?$(CHV.obj.image_viewer.loader).trigger("click"):$(this).toggleClass("zoom-natural")}).on("contextmenu",CHV.obj.image_viewer.container,function(e){if(!CHV.obj.config.image.right_click)return e.preventDefault(),!1}),$(document).on("contextmenu","html.device-mobile a.image-container",function(e){e.preventDefault(),e.stopPropagation()}),$(document).on("keyup","input[data-dashboard-tool]",function(e){if(13==e.keyCode){var t=$("[data-action="+$(this).data("dashboard-tool")+"]");t.click()}}),$(document).on("click","[data-action=dashboardTool]",function(e){e.preventDefault();var t=$(this).data("tool"),a=$(this).data("data"),o=$.extend({},a),i={};for(var n in o){var r=$(o[n]).val();if($(o[n]).prop("disabled")||!r)return;i[n]=$(o[n]),o[n]=r}o.action=t;var s={type:"GET",cache:!1};s.data=o;var l,d=$(this).closest(".input-label"),c=!0;0!=c?(PF.fn.loading.inline($(".loading",d),{size:"small",valign:"middle"}),d.find(".btn .text").hide(),$.ajax(s).complete(function(e){var t=e.responseJSON;$(".loading",d).empty(),d.find(".btn .text").show(),200!=t.status_code||void 0===t.success.redirURL?PF.fn.growl.call(t[200==t.status_code?"success":"error"].message):window.location.href=t.success.redirURL})):PF.fn.growl.call(l)}),$(document).on("click","[data-action=openerPostMessage]",function(e){if(window.opener){e.preventDefault();var t="data-action-target",a=$($(this).is("["+t+"]")?$(this).attr(t):this),o=a[a.is(":input")?"val":"html"]();window.opener.postMessage({id:window.name,message:o},"*")}}),$(document).on("click","[data-action=list-tools] [data-action]",function(e){var t=$(e.target),a=t.closest("[data-id]");a&&a.find("[data-action=select]").exists()&&(e.ctrlKey||e.metaKey)&&e.altKey&&(CHV.fn.list_editor.toggleSelectItem(a,!a.hasClass("selected")),e.preventDefault(),e.stopPropagation())}),PF.fn.listing.ajax.callback=function(e){200===e.status&&CHV.fn.list_editor.listMassActionSet("select")},$(document).on("click","[data-action=list-select-all]",function(e){if($(this).closest(".disabled").exists())return!1;CHV.fn.list_editor.selectAll(e)}),$(document).on("click","[data-action=list-clear-all]",function(e){if($(this).closest(".disabled").exists())return!1;CHV.fn.list_editor.clearSelected()}),$(document).on("click","[data-action=share]",function(e){if(!$(PF.obj.modal.selectors.box).exists()){var t,a,o,i,n,r;t=$(".viewer:visible").exists()?$(PF.obj.listing.selectors.list_item+"[data-id="+$(".viewer").attr("data-id")+"]",".content-listing").first():$(this).closest(PF.obj.listing.selectors.list_item).first();var s="#modal-share";if(t.exists()){if(r=CHV.fn.modal.getTemplateWithPreview(s,t),void 0===t.attr("data-type"))return void console.error("Error: data-type not defined");n=t.find(".list-item-desc-title-link").first(),o=t.find(".image-container img").first().attr("src"),a=t.attr("data-url-short")}else r=$(s).html(),dealing_with=CHV.obj.resource.type,a=CHV.obj.resource.url_short,o="img_viewer"in CHV.obj?CHV.obj.image_viewer.image.display_url:null,n=$(".header > h1 > a");i=encodeURIComponent(n.text());var l=t.attr("data-privacy")||CHV.obj.resource.privacy,d="";switch(l){case"private_but_link":d=PF.fn._s("Note: This content is private but anyone with the link will be able to see this.");break;case"password":d=PF.fn._s("Note: This content is password protected. Remember to pass the content password to share.");break;case"private":d=PF.fn._s('Note: This content is private. Change privacy to "public" to share.')}r=r.replaceAll("__url__",a).replaceAll("__image__",o).replaceAll("__title__",i).replaceAll("__privacy__",l).replaceAll("__privacy_notes__",d),PF.fn.modal.call({type:"html",buttons:!1,template:r})}}),$(document).on("click","[data-action=list-tools] [data-action]",function(e){if(e.isPropagationStopped())return!1;var t;t=$(".viewer:visible").exists()?$(PF.obj.listing.selectors.list_item+"[data-id="+$(".viewer").attr("data-id")+"]",".content-listing").first():$(this).closest(PF.obj.listing.selectors.list_item).first();var a=t.attr("data-id");if(void 0!==t.attr("data-type")){o=t.attr("data-type");var o,i=$("[data-type="+o+"][data-id="+a+"]");switch($(this).data("action")){case"select":CHV.fn.list_editor.toggleSelectItem(t,!t.hasClass("selected"));break;case"edit":var n="[data-modal=form-edit-single]";switch(o){case"image":if(!t.attr("data-tags")){var r=JSON.parse(decodeURIComponent(t.attr("data-object")));t.attr("data-tags",r.tags_string)}$("[name=form-image-title]",n).attr({value:t.attr("data-title"),autocomplete:"off"}),$("[name=form-image-tags]",n).attr({value:t.attr("data-tags"),autocomplete:"off"}),$("[name=form-image-description]",n).html(PF.fn.htmlEncode(t.attr("data-description"))),$("[name=form-album-id]",n).find("option").removeAttr("selected"),$("[name=form-album-id]",n).find('[value="'+t.data("image"==o?"album-id":"id")+'"]').attr("selected",!0),$("[name=form-category-id]",n).find("option").removeAttr("selected"),$("[name=form-category-id]",n).find('[value="'+t.attr("data-category-id")+'"]').attr("selected",!0),$("[name=form-nsfw]",n).attr("checked","unsafe"==t.attr("data-flag")),$("[name=form-album-name]",n).attr({value:"",autocomplete:"off"}),$("[name=form-album-description]",n).html(""),$("[name=form-privacy]",n).find("option").removeAttr("selected");break;case"album":$("[data-action=album-switch]",n).remove(),$("[name=form-album-name]",n).attr({value:t.attr("data-name"),autocomplete:"off"}),$("[name=form-album-description]",n).html(PF.fn.htmlEncode(t.attr("data-description"))),$("[name=form-privacy]",n).find("option").removeAttr("selected"),$("[name=form-privacy]",n).find('[value="'+t.attr("data-privacy")+'"]').attr("selected",!0),"password"==t.attr("data-privacy")?($("[data-combo-value=password]").show(),$("[name=form-album-password]",n).attr("value",t.attr("data-password"))):($("[data-combo-value=password]").hide(),$("[name=form-album-password]",n).attr("value",""))}PF.fn.modal.call({type:"html",template:CHV.fn.modal.getTemplateWithPreview(n,t),ajax:{url:PF.obj.config.json_api,deferred:{success:function(e){console.log("UPDATE ITEM"),CHV.fn.list_editor.updateItem("[data-type="+o+"][data-id="+a+"]",e.responseJSON[o],"edit")}}},confirm:function(){var e=$(PF.obj.modal.selectors.root),i=e.find("form");if(!PF.fn.form.validateForm(i))return!1;if(PF.fn.form_modal_has_changed()){switch(PF.obj.modal.form_data={action:"edit",edit:t.attr("data-type"),single:!0,owner:CHV.obj.resource.user.id,editing:{id:a,description:$("[name=form-"+o+"-description]",e).val()}},o){case"image":PF.obj.modal.form_data.editing.title=$("[name=form-image-title]",e).val(),PF.obj.modal.form_data.editing.tags=$("[name=form-image-tags]",e).val(),PF.obj.modal.form_data.editing.category_id=$("[name=form-category-id]",e).val()||null,PF.obj.modal.form_data.editing.nsfw=$("[name=form-nsfw]",e).prop("checked")?1:0;break;case"album":PF.obj.modal.form_data.editing.name=$("[name=form-album-name]",e).val(),PF.obj.modal.form_data.editing.privacy=$("[name=form-privacy]",e).val(),"password"==PF.obj.modal.form_data.editing.privacy&&(PF.obj.modal.form_data.editing.password=$("[name=form-album-password]",e).val())}return PF.obj.modal.form_data.editing.new_album=$("[data-content=form-new-album]",e).is(":visible"),PF.obj.modal.form_data.editing.new_album?(PF.obj.modal.form_data.editing.album_name=$("[name=form-album-name]",e).val(),PF.obj.modal.form_data.editing.album_privacy=$("[name=form-privacy]",e).val(),"password"==PF.obj.modal.form_data.editing.album_privacy&&(PF.obj.modal.form_data.editing.album_password=$("[name=form-album-password]",e).val()),PF.obj.modal.form_data.editing.album_description=$("[name=form-album-description]",e).val()):PF.obj.modal.form_data.editing.album_id=$("[name=form-album-id]",e).val(),!0}PF.fn.modal.close()}});break;case"create-album":case"move":var s="move"==$(this).data("action")?"form-move-single":"form-create-album";n="[data-modal="+s+"]";$("[name=form-album-id]",n).find("option").removeAttr("selected"),$("[name=form-album-id]",n).find('[value="'+t.attr("image"==o?"data-album-id":"data-id")+'"]').attr("selected",!0),$("[name=form-album-name]",n).attr({value:"",autocomplete:"off"}),$("[name=form-album-description]",n).html(""),$("[name=form-privacy]",n).find("option").removeAttr("selected"),PF.fn.modal.call({type:"html",template:CHV.fn.modal.getTemplateWithPreview(n,i),ajax:{url:PF.obj.config.json_api,deferred:{success:function(e){CHV.fn.list_editor.updateMoveItemLists(e.responseJSON,o,i),"form-create-album"===s&&(window.location=e.responseJSON.image.album.url)}}},load:function(){},confirm:function(){var e=$(PF.obj.modal.selectors.root),o=e.find("form");return!!PF.fn.form.validateForm(o)&&(PF.fn.form_modal_has_changed()?(PF.obj.modal.form_data={action:"edit",edit:t.attr("data-type"),single:!0,owner:CHV.obj.resource.user.id,editing:{id:a}},PF.obj.modal.form_data.editing.new_album=$("[data-content=form-new-album]",e).is(":visible"),PF.obj.modal.form_data.editing.new_album?(PF.obj.modal.form_data.editing.album_name=$("[name=form-album-name]",e).val(),PF.obj.modal.form_data.editing.album_privacy=$("[name=form-privacy]",e).val(),"password"==PF.obj.modal.form_data.editing.album_privacy&&(PF.obj.modal.form_data.editing.album_password=$("[name=form-album-password]",e).val()),PF.obj.modal.form_data.editing.album_description=$("[name=form-album-description]",e).val()):PF.obj.modal.form_data.editing.album_id=$("[name=form-album-id]",e).val(),!0):void PF.fn.modal.close())}});break;case"approve":PF.fn.modal.call({type:"html",template:CHV.fn.modal.getTemplateWithPreview("[data-modal=form-approve-single]",t),button_submit:PF.fn._s("Confirm"),ajax:{url:PF.obj.config.json_api,deferred:{success:function(e){CHV.fn.list_editor.removeFromList(t,PF.fn._s("The content has been approved."))}}},confirm:function(){return PF.obj.modal.form_data={action:"approve",single:!0,approve:t.attr("data-type"),approving:{id:a}},!0}});break;case"delete":PF.fn.modal.call({type:"html",template:CHV.fn.modal.getTemplateWithPreview("[data-modal=form-delete-single]",t),button_submit:PF.fn._s("Confirm"),ajax:{url:PF.obj.config.json_api,deferred:{success:function(e){"album"==o&&($("[name=form-album-id]","[data-modal]").find('[value="'+a+'"]').remove(),CHV.fn.list_editor.updateUserCounters("image",e.responseJSON.success.affected,"-")),CHV.fn.list_editor.deleteFromList(t),CHV.fn.listingViewer.close()}}},confirm:function(){return PF.obj.modal.form_data={action:"delete",single:!0,delete:t.attr("data-type"),deleting:{id:a}},!0}});break;case"flag":$.ajax({type:"POST",data:{action:"edit",edit:"image",single:!0,editing:{id:a,nsfw:"unsafe"==t.attr("data-flag")?0:1}}}).complete(function(e){var t=e.responseJSON;if(200==t.status_code){var a=1==t.image.nsfw?"unsafe":"safe";i.attr("data-flag",a).data("flag",a)}else PF.fn.growl.call(t.error.message);CHV.fn.list_editor.selectionCount()})}}else console.error("Error: data-type not defined")}),$(".pop-box-menu a","[data-content=list-selection]").click(function(e){var t=$(PF.obj.listing.selectors.content_listing_visible);if(void 0!==t.data("list")){dealing_with=t.data("list");var a=$(PF.obj.listing.selectors.list_item+".selected",t),o=$.map(a,function(e,t){return $(e).data("id")});switch(PF.fn.close_pops(),"list-select-all"!==$(this).data("action")&&e.stopPropagation(),$(this).data("action")){case"get-embed-codes":var i="[data-modal=form-embed-codes]",n=[];$("textarea",i).html(""),a.each(function(){var e={image:JSON.parse(decodeURIComponent($(this).data("object")))};"url"in e.image&&n.push(e)}),CHV.fn.fillEmbedCodes(n,i,"html"),PF.fn.modal.call({type:"html",template:CHV.fn.modal.getTemplateWithPreviews(i,a),buttons:!1});break;case"clear":e.stopPropagation(),CHV.fn.list_editor.clearSelected();break;case"list-select-all":CHV.fn.list_editor.selectAll(e);break;case"move":case"create-album":i="move"==$(this).data("action")?"form-move-multiple":"form-create-album"
;var r="[data-modal="+i+"]",s=/image/.test(dealing_with)?"album-id":"id";$("[name=form-album-id]",r).find('[value="null"]').remove(),$("[name=form-album-id]",r).find("option").removeAttr("selected"),$("[name=form-album-name]",r).attr({value:"",autocomplete:"off"}),$("[name=form-album-description]",r).html(""),$("[name=form-privacy]",r).find("option").removeAttr("selected");var l=a.first().data(s),d=!0;a.each(function(){if($(this).data(s)!==l)return d=!1,!1}),d||$("[name=form-album-id]",r).prepend('<option value="null">'+PF.fn._s("Select existing album")+"</option>"),$("[name=form-album-id]",r).find('[value="'+(d?a.first().data(s):"null")+'"]').attr("selected",!0),PF.fn.modal.call({type:"html",template:CHV.fn.modal.getTemplateWithPreviews(r,a),ajax:{url:PF.obj.config.json_api,deferred:{success:function(e){CHV.fn.list_editor.updateMoveItemLists(e.responseJSON,dealing_with,a),"form-create-album"===i&&(window.location=e.responseJSON.album.url)}}},load:function(){},confirm:function(){var e=$(PF.obj.modal.selectors.root),t=!1,a=e.find("form");return!!PF.fn.form.validateForm(a)&&($("[data-content=form-new-album]",e).is(":visible")&&(t=!0),PF.fn.form_modal_has_changed()?(PF.obj.modal.form_data={action:t?"create-album":"move",type:dealing_with,owner:CHV.obj.resource.user.id,multiple:!0,album:{ids:o,new:t}},t?(PF.obj.modal.form_data.album.name=$("[name=form-album-name]",e).val(),PF.obj.modal.form_data.album.privacy=$("[name=form-privacy]",e).val(),"password"==PF.obj.modal.form_data.album.privacy&&(PF.obj.modal.form_data.album.password=$("[name=form-album-password]",e).val()),PF.obj.modal.form_data.album.description=$("[name=form-album-description]",e).val()):PF.obj.modal.form_data.album.id=$("[name=form-album-id]",e).val(),!0):void PF.fn.modal.close())}});break;case"approve":PF.fn.modal.call({template:CHV.fn.modal.getTemplateWithPreviews("[data-modal=form-approve-multiple]",a),button_submit:PF.fn._s("Confirm"),ajax:{url:PF.obj.config.json_api,deferred:{success:function(e){CHV.fn.list_editor.removeFromList(a,PF.fn._s("The content has been approved."))}}},confirm:function(){return PF.obj.modal.form_data={action:"approve",from:"list",approve:dealing_with,multiple:!0,approving:{ids:o}},!0}});break;case"delete":PF.fn.modal.call({template:CHV.fn.modal.getTemplateWithPreviews("[data-modal=form-delete-multiple]",a),button_submit:PF.fn._s("Confirm"),ajax:{url:PF.obj.config.json_api,deferred:{success:function(e){"albums"==dealing_with&&(a.each(function(){$("[name=form-album-id]","[data-modal]").find('[value="'+$(this).data("id")+'"]').remove()}),CHV.fn.list_editor.updateUserCounters("image",e.responseJSON.success.affected,"-")),CHV.fn.list_editor.deleteFromList(a)}}},confirm:function(){return PF.obj.modal.form_data={action:"delete",from:"list",delete:dealing_with,multiple:!0,deleting:{ids:o}},!0}});break;case"assign-category":var c=a.first().data("category-id"),u=!0;a.each(function(){if($(this).data("category-id")!==c)return u=!1,!1}),PF.fn.modal.call({type:"html",template:CHV.fn.modal.getTemplateWithPreviews("[data-modal=form-assign-category]",a),forced:!0,ajax:{url:PF.obj.config.json_api,deferred:{success:function(e){a.each(function(){var t=e.responseJSON;$(this).data("category-id",t.category_id)}),CHV.fn.list_editor.clearSelected()}}},confirm:function(){var e=$(PF.obj.modal.selectors.root),t=$("[name=form-category-id]",e).val()||null;return u&&c==t?(PF.fn.modal.close(function(){CHV.fn.list_editor.clearSelected()}),!1):(PF.obj.modal.form_data={action:"edit-category",from:"list",multiple:!0,editing:{ids:o,category_id:t}},!0)}});break;case"flag-safe":case"flag-unsafe":var m=$(this).data("action"),f="flag-safe"==m?"safe":"unsafe";PF.fn.modal.call({template:CHV.fn.modal.getTemplateWithPreviews("[data-modal=form-"+m+"]",a),button_submit:PF.fn._s("Confirm"),ajax:{url:PF.obj.config.json_api,deferred:{success:function(e){a.each(function(){$(this).removeClass("safe unsafe").addClass(f).removeAttr("data-flag").attr("data-flag",f).data("flag",f)}),CHV.fn.list_editor.clearSelected()}}},confirm:function(){return PF.obj.modal.form_data={action:m,from:"list",multiple:!0,editing:{ids:o,nsfw:"flag-safe"==m?0:1}},!0}})}return!PF.fn.isDevice(["phone","phablet"])&&void 0}console.error("Error: data-list not defined")}),$(document).on("click","[data-action=disconnect]",function(){var e=$(this),t=e.data("connection");PF.fn.modal.confirm({message:e.data("confirm-message"),ajax:{data:{action:"disconnect",disconnect:t,user_id:CHV.obj.resource.user.id},deferred:{success:function(e){var a=e.responseJSON;$("[data-connection="+t+"]").fadeOut(function(){$($("[data-connect="+t+"]")).fadeIn(),$(this).remove(),0==$("[data-connection]").length&&$("[data-content=empty-message]").show()}),""!==a.success.redirect&&(window.location.href=a.success.redirect)},error:function(e){var t=e.responseJSON;PF.fn.growl.call(t.error.message)}}}})}),$(document).on("click","[data-action=delete-avatar]",function(){var e=$(".user-settings-avatar"),t=$(".loading-placeholder",e),a=$("#top-bar");t.removeClass("hidden"),PF.fn.loading.inline(t,{center:!0}),$.ajax({type:"POST",data:{action:"delete",delete:"avatar",owner:CHV.obj.resource.user.id}}).complete(function(o){t.addClass("hidden").empty(),200==o.status?(CHV.obj.logged_user.id==CHV.obj.resource.user.id&&($("img.user-image",a).hide(),$(".default-user-image",a).removeClass("hidden")),$(".default-user-image",e).removeClass("hidden").css({opacity:0}),$('[data-action="delete-avatar"]',e).parent().addClass("soft-hidden"),$("img.user-image",e).fadeOut(function(){$(".default-user-image",e).animate({opacity:1})})):PF.fn.growl.call(PF.fn._s("An error occurred. Please try again later."))})}),$(document).on("change","[data-content=user-avatar-upload-input]",function(e){e.preventDefault(),e.stopPropagation();var t=$(this),a=$(".user-settings-avatar"),o=$(".loading-placeholder",".user-settings-avatar"),i=$("#top-bar"),n=$(this)[0].files[0];if(!t.data("uploading"))if(0!=/^image\/.*$/.test(n.type))if(n.size>CHV.obj.config.user.avatar_max_filesize.getBytes())PF.fn.growl.call(PF.fn._s("Please select a picture of at most %s size.",CHV.obj.config.user.avatar_max_filesize));else{var r=$('[data-action="delete-avatar"]');o.removeClass("hidden"),PF.fn.loading.inline(o,{center:!0}),t.data("uploading",!0);var s=new FormData;s.append("source",n),s.append("action","upload"),s.append("type","file"),s.append("what","avatar"),s.append("owner",CHV.obj.resource.user.id),s.append("auth_token",PF.obj.config.auth_token),avatarXHR=new XMLHttpRequest,avatarXHR.open("POST",PF.obj.config.json_api,!0),avatarXHR.send(s),avatarXHR.onreadystatechange=function(){if(4==this.readyState){var e="json"!==this.responseType?JSON.parse(this.response):this.response,n=e.success.image;o.addClass("hidden").empty(),200==this.status?(change_avatar=function(e){r.parent().removeClass("soft-hidden"),$("img.user-image",e).attr("src",n.url).removeClass("hidden").show()},hide_default=function(e){$(".default-user-image",e).addClass("hidden")},hide_default(a),$(".btn-alt",a).closest("div").show(),change_avatar(a),CHV.obj.logged_user.id==CHV.obj.resource.user.id&&(change_avatar(i),hide_default(i))):PF.fn.growl.call(PF.fn._s("An error occurred. Please try again later.")),t.data("uploading",!1)}}}else PF.fn.growl.call(PF.fn._s("Please select a valid image file type."))}),$(document).on("change","[data-content=user-background-upload-input]",function(e){e.preventDefault(),e.stopPropagation();var t=$(this),a=$("[data-content=user-background-cover]"),o=$("[data-content=user-background-cover-src]"),i=$(".loading-placeholder",a),n=($("#top-bar"),$(this)[0].files[0]);if(!t.data("uploading"))if(0!=/^image\/.*$/.test(n.type))if(n.size>CHV.obj.config.user.background_max_filesize.getBytes())PF.fn.growl.call(PF.fn._s("Please select a picture of at most %s size.",CHV.obj.config.user.background_max_filesize));else{i.removeClass("hidden"),PF.fn.loading.inline(i,{center:!0,size:"big",color:"#FFF"}),t.data("uploading",!0);var r=new FormData;r.append("source",n),r.append("action","upload"),r.append("type","file"),r.append("what","background"),r.append("owner",CHV.obj.resource.user.id),r.append("auth_token",PF.obj.config.auth_token),avatarXHR=new XMLHttpRequest,avatarXHR.open("POST",PF.obj.config.json_api,!0),avatarXHR.send(r),avatarXHR.onreadystatechange=function(){if(4==this.readyState){var e="json"!==this.responseType?JSON.parse(this.response):this.response,n=e.success.image;if(200==this.status){var r=$("<img/>");r.attr("src",n.url).imagesLoaded(function(){i.addClass("hidden").empty(),o.css("background-image","url("+n.url+")").hide().fadeIn(),$("[data-content=user-change-background]",a).removeClass("hidden"),$(a).removeClass("no-background"),$(".top-user").removeClass("no-background"),$("[data-content=user-upload-background]").hide(),$("[data-content=user-change-background]").show(),r.remove()})}else i.addClass("hidden").empty(),PF.fn.growl.call(PF.fn._s("An error occurred. Please try again later."));t.data("uploading",!1)}}}else PF.fn.growl.call(PF.fn._s("Please select a valid image file type."))}),$(document).on("keyup change",CHV.str.mainform+" :input",function(){$(this).is("[name=username]")&&$("[data-text=username]").text($(this).val())}),$(document).on("change",CHV.obj.timezone.input,function(){var e=$(this).val(),t=$("#timezone-combo-"+e);t.find("option:first").prop("selected",!0),$(CHV.obj.timezone.selector).val(t.val()).change()}),$(document).on("change","[id^=timezone-combo-]",function(){var e=$(this).val();$(CHV.obj.timezone.selector).val(e).change()}),$(document).on("keyup change blur","[name^=new-password]",function(){var e=$("[name=new-password]"),t=$("[name=new-password-confirm]"),a=e.val()==t.val(),o=t.closest(".input-password").find(".input-warning");0==o.exists()&&(o=$("[data-message=new-password-confirm]")),$(this).is(t)&&t.data("touched",!0),t.data("touched")&&o.text(a?"":o.data("text"))[a?"addClass":"removeClass"]("hidden-visibility")}),$(document).on("submit",CHV.obj.mainform,function(){switch($(this).data("type")){case"password":var e=$("[name=new-password]",this),t=$("[name=new-password-confirm]",this);if((""!==e.val()||""!==t.val())&&e.val()!==t.val())return e.highlight(),t.highlight(),PF.fn.growl.call(PF.fn._s("Passwords don't match")),!1}}),$(document).on("click","[data-action=check-for-updates]",function(){PF.fn.loading.fullscreen(),CHV.fn.system.checkUpdates(function(e){if(PF.fn.loading.destroy("fullscreen"),200===e.status){var t=e.responseJSON.software;if(-1==PF.fn.versionCompare(CHV.obj.system_info.version,t.current_version)){let e=CHV.obj.system_info.version.split("."),a=e[0],o=a+"."+e[1],i="_self",n=PF.obj.config.base_url+"dashboard/upgrade/?auth_token="+PF.obj.config.auth_token,r=PF.fn._s("Upgrade"),s="fas fa-download";"docker"===CHV.obj.system_info.servicing&&(i="_blank",n="https://v4-docs.chevereto.com/guides/docker/#upgrading",r=PF.fn._s("Instructions"),s="fa-brands fa-docker"),PF.fn.modal.simple({title:'<i class="fas fa-arrow-alt-circle-up"></i> '+PF.fn._s("Chevereto v%s available",t.current_version),message:"<p>"+PF.fn._s("There is a new Chevereto version available with the following release notes.")+" "+PF.fn._s("Check %s for a complete changelog since you last upgrade.",'<a href="https://releases.chevereto.com/'+a+".X/"+o+"/"+CHV.obj.system_info.version+'" target="_blank">'+CHV.obj.system_info.version+'<span class="btn-icon fas fas fa-code-branch"></span></a>')+'</p><textarea class="r4 resize-vertical">'+t.release_notes.trim()+"</textarea><p>"+PF.fn._s("Check the %s for alternative update methods.",'<a href="https://chevereto.com/go/v4update" target="_blank">'+PF.fn._s("documentation")+"</a>")+'</p><div class="btn-container margin-bottom-0"><a href="'+n+'" class="btn btn-input accent" target="'+i+'"><span class="btn-icon '+s+' user-select-none"></span><span class="btn-text user-select-none">'+r+"</span></a> </div>",html:!0})}else PF.fn.growl.call(PF.fn._s("This website is running latest %s version",CHEVERETO.edition))}else PF.fn.growl.call(PF.fn._s("An error occurred. Please try again later."))})}),void 0!==PF.fn.get_url_var("checkUpdates")&&$("[data-action=check-for-updates]").trigger("click"),void 0!==PF.fn.get_url_var("upgrade")&&$("[data-action=upgrade]").trigger("click"),void 0!==PF.fn.get_url_var("license")&&$("[data-action='license']").trigger("click"),void 0!==PF.fn.get_url_var("welcome")&&PF.fn.modal.call({template:$("[data-modal=welcome]").html(),buttons:!1}),void 0!==PF.fn.get_url_var("installed")&&PF.fn.modal.simple({title:'<i class="fas fa-code-branch"></i> '+PF.fn._s("Chevereto v%s installed",CHV.obj.system_info.version),message:"<p>"+PF.fn._s('Usage of Chevereto Software must be in compliance with the software license terms known as "The Chevereto License".')+'</p><div class="btn-container margin-bottom-0"><a href="https://chevereto.com/license" target="_blank" class="btn btn-input accent"><span class="btn-icon fas fa-file-contract user-select-none"></span><span class="btn-text user-select-none">'+PF.fn._s("License agreement")+"</span></a> </div>",html:!0}),$(document).on("click","[data-action=system-update]",function(e){if(!$("input#system-update").prop("checked"))return PF.fn.growl.call(PF.fn._s("Please review the system requirements before proceeding")),void e.preventDefault()}),$(document).on("click","[data-action=toggle-storage-https]",function(){CHV.fn.storage.toggleHttps($(this).closest("[data-content=storage]").data("storage-id"))}),$(document).on("click","[data-action=toggle-storage-active]",function(){CHV.fn.storage.toggleActive($(this).closest("[data-content=storage]").data("storage-id"))}),$(CHV.fn.uploader.selectors.root).exists()&&(CHV.fn.uploader.$pasteCatcher=$("<div />",{contenteditable:"true",id:CHV.fn.uploader.selectors.paste.replace(/#/,"")}),$("body").append(CHV.fn.uploader.$pasteCatcher),$(document).on("keydown",function(e){!e.ctrlKey&&!e.metaKey||"KeyV"!=e.originalEvent.code||$(e.target).is(":input")||(PF.fn.keyFeedback.spawn(e),CHV.fn.uploader.$pasteCatcher.focus(e))}),document.addEventListener("dragover",function(e){e.preventDefault()}),document.addEventListener("drop",function(e){if(CHV.obj.config.upload.url){e.preventDefault();var t,a=e.dataTransfer.getData("text/html"),o=/src="?([^"\s]+)"?\s*/;t=o.exec(a),t&&(CHV.fn.uploader.toggle({show:!0}),CHV.fn.uploader.add({},t[1]))}}),window.addEventListener("paste",CHV.fn.uploader.pasteImageHandler)),$(document).on("click","[data-action=like]",function(){if(PF.fn.is_user_logged()){var e=$(this);if(!e.data("XHR")){e.data("XHR",!0);var t=$(this).is("[data-liked]")?$(this):$(this).closest("[data-liked]"),a=!t.closest("[data-list], .viewer").exists()&&void 0!==CHV.obj.resource,o=t.is("[data-liked=1]"),i=o?"dislike":"like",n={id:a?CHV.obj.resource.id:$(this).closest("[data-id]").attr("data-id"),type:a?CHV.obj.resource.type:$(this).closest("[data-type]").attr("data-type")},r=a?e:$("[data-type="+n.type+"][data-id="+n.id+"]"),s={type:"POST",data:{action:i},cache:!1};s.data[i]={object:n.type,id:n.id},$.ajax(s).complete(function(t){var i=t.responseJSON;e.data("XHR",!1),200===i.status_code?(a&&void 0!==i.content&&$("[data-text=likes-count]").html(i.content.likes),r.closest("[data-liked]").attr("data-liked",o?0:1)):PF.fn.growl.call(PF.fn._s("An error occurred. Please try again later."))})}}else window.location.href=CHV.obj.vars.urls.login}),$(document).on("click","[data-action=album-cover]",function(){var e=$(this);if(!e.data("XHR")){e.data("XHR",!0);var t=$(this).is("[data-cover]")?$(this):$(this).closest("[data-cover]"),a=t.is("[data-cover=1]"),o=a?"album-cover-unset":"album-cover-set",i=(CHV.obj.resource.id,e.closest("[data-cover]")),n={type:"POST",data:{action:o},cache:!1};n.data[o]={album_id:i.data("album-id"),image_id:i.data("id")},$.ajax(n).complete(function(t){var o=t.responseJSON;e.data("XHR",!1),200===o.status_code?i.attr("data-cover",a?0:1):PF.fn.growl.call(PF.fn._s("An error occurred. Please try again later."))})}}),$(document).on("click","[data-action=follow]",function(){if(PF.fn.is_user_logged()){var e=$(this);if(!e.data("XHR")){e.data("XHR",!0);var t=$(this).is("[data-followed]")?$(this):$(this).closest("[data-followed]"),a=void 0!==CHV.obj.resource,o=t.is("[data-followed=1]"),i=o?"unfollow":"follow",n={id:a?CHV.obj.resource.id:$(this).closest("[data-id]").data("id"),type:a?CHV.obj.resource.type:$(this).closest("[data-type]").data("type")},r={type:"POST",data:{action:i},cache:!1};r.data[i]={object:n.type,id:n.id},$.ajax(r).complete(function(i){var n=i.responseJSON;if(e.data("XHR",!1),200===n.status_code){if(a&&void 0!==n.user_followed){var r=$("[data-text=followers-label]"),s={single:r.data("label-single"),plural:r.data("label-plural")};$("[data-text=followers-count]").html(n.user_followed.followers),r.html(PF.fn._n(s.single,s.plural,n.user_followed.followers))}t.attr("data-followed",o?0:1)}else PF.fn.growl.call(PF.fn._s("An error occurred. Please try again later."))})}}else PF.fn.modal.call({type:"login"})}),$(document).on("click","[data-action=user_ban],[data-action=user_unban]",function(){var e=$(this);if(!e.data("XHR")){e.data("XHR",!0);var t=$(this).closest("[data-banned]"),a=!0,o=t.is("[data-banned=1]"),i=e.attr("data-action"),n={id:a?CHV.obj.resource.id:$(this).closest("[data-id]").data("id"),type:a?CHV.obj.resource.type:$(this).closest("[data-type]").data("type")},r={type:"POST",data:{action:i},cache:!1};r.data[i]={user_id:n.id},$.ajax(r).complete(function(a){var i=a.responseJSON;e.data("XHR",!1),200===i.status_code?t.attr("data-banned",o?0:1):PF.fn.growl.call(PF.fn._s("An error occurred. Please try again later."))})}}),$(document).on("click","[data-action=top-bar-notifications]",function(e){var a=this,o=$(this),i=$(".top-bar-notifications-container",o),n=$(".top-bar-notifications-list",o),r=$("ul",n),s=$(".loading",i);o.data("XHR")||(s.removeClass("hidden"),PF.fn.loading.inline(s,{size:"small",message:PF.fn._s("loading")}),$.ajax({type:"POST",data:{action:"notifications"},cache:!1}).complete(function(e){var l=e.responseJSON;if(200!==l.status_code)return PF.fn.growl.call(PF.fn._s("An error occurred. Please try again later.")),o.data("XHR",!1),void s.addClass("hidden").html("");if(o.data("XHR",!0),s.remove(),l.html){n.removeClass("hidden"),r.html(l.html),t();var d=$("li.new",r);d.addClass("transition"),setTimeout(function(){d.removeClass("new"),$("[data-content=notifications-counter]",a).removeClass("on").html("0"),setTimeout(function(){d.removeClass("transition")},150)},1500)}else $(".empty",i).removeClass("hidden")}))}),$("#g-recaptcha").is(":empty")&&CHV.obj.config.captcha.enabled&&CHV.obj.config.captcha.sitekey&&("3"!=CHV.obj.config.captcha.version&&CHV.obj.config.captcha.isNeeded||$('label[for="recaptcha_response_field"]').remove()),$(document).on("click",PF.obj.listing.selectors.list_item+" a.image-container",function(e){var t=$(this).closest(PF.obj.listing.selectors.list_item),o=t.find("[data-action=load-image]");o.length>0&&(a(o),e.preventDefault())}),$(document).on("click",PF.obj.listing.selectors.list_item+" [data-action=load-image]",function(e){a($(this)),e.preventDefault(),e.stopPropagation()}),$(document).on("click","#album [data-tab=tab-embeds]",function(e){e.preventDefault,CHV.fn.album.showEmbedCodes()}),$("body").is("#upload")&&CHV.fn.uploader.toggle({show:!0}),$(document).on("keyup",function(e){if(!($(e.target).is(":input")||e.ctrlKey||e.metaKey||e.altKey)){var t=$("#fullscreen-modal:visible").exists(),a=$(".viewer"),o=$(".list-selection:visible"),i=o.find("[data-content=pop-selection]:visible:not(.disabled)"),n=$("body").hasClass("--viewer-shown"),r=$(CHV.fn.uploader.selectors.root+CHV.fn.uploader.selectors.show).exists(),s=e.originalEvent.code;if("Escape"===e.originalEvent.code){if(t)return;r&&CHV.fn.uploader.toggle({reset:!1})}if(a.exists()&&n){if(s in CHV.fn.listingViewer.keys){var l=["KeyW","Escape","ArrowLeft","ArrowRight"],d=CHV.fn.listingViewer.keys[s];-1==l.indexOf(s)?$("[data-action="+d+"]",CHV.fn.listingViewer.selectors.root).click():d in CHV.fn.listingViewer&&CHV.fn.listingViewer[d](),PF.fn.keyFeedback.spawn(e)}}else{var c,u={Period:"list-select-all",KeyK:"get-embed-codes",KeyZ:"clear",KeyA:"create-album",KeyM:"move",KeyO:"approve",Delete:"delete",Backspace:"delete",KeyC:"assign-category",KeyV:"flag-safe",KeyF:"flag-unsafe",KeyH:"album-cover"},m={KeyE:"edit",KeyL:"like",KeyS:"share",KeyJ:"sub-album",KeyP:"upload-to-album"};d=u[s]||m[s];void 0!==d&&(o.exists()&&(n||t||parseInt($("[data-text=selection-count]:visible",i).text())>0&&(c=$("[data-action="+d+"]",o.closest(".list-selection")))),void 0===c&&(c=$("[data-action="+d+"]:visible").not("#content-listing-tabs *")),c instanceof jQuery&&c.length>0&&(c.first().trigger("click"),PF.fn.keyFeedback.spawn(e)))}}}),$(document).on("click",CHV.fn.listingViewer.selectors.root+" [data-action^=viewer-]",function(){var e=$(this).data("action").substring("viewer-".length);e in CHV.fn.listingViewer&&CHV.fn.listingViewer[e]()}),$(document).on("click","a[data-href]:not([rel=popup-link]):not(.popup-link)",function(){var e=$(this).attr("data-href"),t=$(this).attr("href");(e||t)&&(location.href=t||e)});var g,h=PF.obj.listing.selectors.list_item+", .image-container";($(document).on("contextmenu click",h,function(e){!$(".list-selection:visible").exists()||$(e.target).closest(".list-item-desc").exists()||$(this).closest(CHV.fn.listingViewer.selectors.root).exists()||"click"==e.type&&!e.ctrlKey&&!e.metaKey||o(this,e)}),navigator.userAgent.match(/(iPad|iPhone|iPod)/i))&&$(document).on("mouseup mousemove",h,function(e){return clearTimeout(g),!1}).on("mousedown",h,function(e){var t=this,a=e;return g=window.setTimeout(function(){$(".list-selection:visible").exists()&&!$(t).closest(CHV.fn.listingViewer.selectors.root).exists()&&o(t,a)},500),!1});void 0!==CHV.obj.config&&CHV.obj.config.listing.viewer&&$(document).on("click",PF.obj.listing.selectors.list_item+"[data-type=image] .image-container",function(e){if(e.preventDefault(),e.stopPropagation(),0!==e.clientX||0!==e.clientY){var t=$(this).closest(PF.obj.listing.selectors.list_item);t.exists()&&(e.ctrlKey||e.metaKey||CHV.fn.listingViewer.open(t))}else PF.fn.keyFeedback.spawn(e)}),$(document).on("contextmenu",CHV.fn.listingViewer.selectors.root,function(e){return e.preventDefault(),CHV.fn.listingViewer.zoom(),PF.fn.keyFeedback.spawn(e),!1});var v,b=PF.fn.deparam(window.location.search);if(b&&"viewer"in b){var _=$(PF.obj.listing.selectors.content_listing_visible);if("images"==_.data("list")){var C=$(PF.obj.listing.selectors.list_item,_)["next"==b.viewer?"first":"last"]();CHV.fn.listingViewer.open(C)}}var w=function(){$(PF.obj.listing.selectors.list_item+":visible").each(function(){var e=$(this).find('[data-action="load-image"]').first(),t=PF.fn.parseQueryString($(PF.obj.listing.selectors.list_item+"[data-id="+$(this).attr("data-id")+"]").closest(".content-listing").data("params-hidden")),o=t&&"is_animated"in t?t.is_animated:$(this).data("size")<=CHV.obj.config.image.load_max_filesize.getBytes();e.exists()&&o&&$(this).is_within_viewport(50)&&a(e)})};$(window).on("DOMContentLoaded load",function(){clearTimeout(v),v=setTimeout(w,500)}),$(window).on("resize scroll",function(){clearTimeout(v),v=setTimeout(w,1e3)}),$(document).on("click","[data-action=logout]",function(){let e=$("form#form-logout");e.submit()}),Boolean(window.navigator.vibrate)&&$(document).on("click","button, .btn, .pop-btn, .top-btn-el, [data-action], .content-tabs a, .top-bar-logo a, .login-provider-button, .panel-share-networks li a, #image-viewer-loader",function(e){$(this).is("[data-action=top-bar-menu-full]")||e.isPropagationStopped||e.isDefaultPrevented||window.navigator.vibrate([0,15])}),$(document).on("change keyup",CHV.fn.ctaForm.selectors.rows+" input[name^='cta-']",function(){CHV.fn.ctaForm.update($(this))}),$(document).on("click",CHV.fn.ctaForm.selectors.rows+" [data-action=cta-add]",function(){CHV.fn.ctaForm.insert($(this))}),$(document).on("click",CHV.fn.ctaForm.selectors.rows+" [data-action=cta-remove]",function(){CHV.fn.ctaForm.remove($(this)),0==CHV.fn.ctaForm.array.length&&$(CHV.fn.ctaForm.selectors.root+" "+CHV.fn.ctaForm.selectors.enable).prop("checked",!1).trigger("change")}),$(document).on("change",CHV.fn.ctaForm.selectors.root+" "+CHV.fn.ctaForm.selectors.enable,function(){let e=$(CHV.fn.ctaForm.selectors.combo,CHV.fn.ctaForm.selectors.root),t=$(this).is(":checked");e.toggleClass("soft-hidden",!t),t&&(0==CHV.fn.ctaForm.array.length&&CHV.fn.ctaForm.add(),CHV.fn.ctaForm.render()),CHV.fn.ctaForm.setEnable(t?1:0)}),$(document).on("change keyup",CHV.fn.ctaForm.selectors.root+" input[name^='cta-icon_']",function(){let e=CHV.fn.ctaForm.getRow($(this)),t=e.find("label[for^='cta-icon_'] [data-content=icon]");t.removeClass();let a=CHV.fn.ctaForm.getIconClass($(this).val());t.addClass(a)}),$(document).on("click","[href^='https://chevereto.com/']",function(e){let t=$(this).find(".badge--paid").exists();if(!t)return;let a=$(this).attr("href"),o=PF.fn._s("Get a license at %s to unlock all features and support.",'<a href="'+a+'" target="_blank">chevereto.com</a>'),i=PF.fn._s("You can enter your license key in the dashboard panel."),n=PF.obj.config.base_url+"dashboard/?license",r="_self",s="fas fa-key",l=PF.fn._s("Enter license");"docker"===CHV.obj.system_info.servicing&&(i=PF.fn._s("You can upgrade by following the instructions in the documentation."),n="https://v4-docs.chevereto.com/guides/docker/#upgrading",r="_blank",s="fa-brands fa-docker",l=PF.fn._s("Instructions")),e.preventDefault(),e.stopPropagation(),PF.fn.modal.simple({html:!0,title:'<i class="fa-solid fa-boxes-packing"></i> Upgrade Chevereto',message:"<p>"+o+" "+i+'</p><div class="btn-container margin-bottom-0"><a href="'+n+'" target="'+r+'" class="btn btn-input accent"><span class="btn-icon '+s+' user-select-none"></span><span class="btn-text user-select-none">'+l+"</span></a> </div>"})}),$(document).on("focus","input[name='form-album-password']",function(){$(this).get(0).type="text"}),$(document).on("blur","input[name='form-album-password']",function(){$(this).get(0).type="password"}),$("button[type=submit]","form").on("click",function(e){e.preventDefault(),e.stopPropagation(),$(this).closest("form").trigger("submit")});var H=$("template#tags-autocomplete-item").html(),V={};$(document).on("keyup","input[data-autocomplete=tags]",function(e){var t=$(this).val(),a=/[^\,]*$/.exec(t)[0],o=$($(this).data("target"));a=a.trim(),a.length<1||"Escape"===e.key?o.empty():a in V?i(V[a],H,o):$.ajax({url:PF.obj.config.base_url+"tag-autocomplete/",data:{q:a},type:"GET",dataType:"json",cache:!0}).always(function(e){200==e.status_code&&(V[a]=e.items,i(e.items,H,o))})}),$(document).on("click",".content-tags-autocomplete li",function(){var e=$(this).text().trim(),t=$(this).closest(".content-tags-autocomplete"),a=t.attr("id"),o=$('input[data-target="#'+a+'"]'),i=o.val(),n=i.split(",").map(e=>e.trim());t.empty(),n.includes(e)||(n.pop(),n.push(e),o.val(n.join(", ")))}),$(document).on("blur","input[data-autocomplete=tags]",function(){var e=$($(this).data("target"));setTimeout(function(){0===e.find(":active").length&&e.empty()},150)})});